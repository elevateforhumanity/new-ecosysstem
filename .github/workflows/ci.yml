name: CI + Deploy + SEO

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    env:
      SITE_URL: https://yourdomain.com  # TODO: replace with your live domain
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci
      - run: npm run lint --if-present
      - run: npm run typecheck --if-present
      - run: npm run test --if-present

      - run: npm run build
      # do not run sitemap separately; postbuild already handled it
      # - run: npm run sitemap

      - name: Verify sitemap files exist
        run: |
          test -f dist/robots.txt
          test -f dist/sitemap-index.xml

      - name: Serve dist and verify HTTP
        run: |
          npx vite preview --port 4173 --strictPort &
          PID=$!
          n=0
          until curl -fsS http://localhost:4173/robots.txt >/dev/null; do
            n=$((n+1)); [ $n -gt 30 ] && echo "Server failed to start" && exit 1
            sleep 1
          done
          curl -fsS http://localhost:4173/sitemap-index.xml >/dev/null
          kill $PID

      - name: Deploy to Vercel
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: npx vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }}

      - name: Health check deployed site
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "üåê Checking ${SITE_URL} ..."
          STATUS=$(curl -fsSL --retry 3 --retry-delay 2 -o /dev/null -w "%{http_code}" "${SITE_URL}")
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ Site is live (200 OK)"
          else
            echo "‚ùå Health check failed (status: $STATUS)"
            exit 1
          fi

      - name: Notify Google (ping sitemap)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: curl -fsS --retry 3 --retry-delay 2 "https://www.google.com/ping?sitemap=${SITE_URL}/sitemap-index.xml" -o /dev/null

      - name: Notify Bing (ping sitemap)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: curl -fsS --retry 3 --retry-delay 2 "https://www.bing.com/ping?sitemap=${SITE_URL}/sitemap-index.xml" -o /dev/null