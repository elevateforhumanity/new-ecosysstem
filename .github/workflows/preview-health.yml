name: Preview Health (Port 9000)
on:
  pull_request:
  push:
    branches: [ main ]
jobs:
  health:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: 
          node-version: 18
          cache: npm
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            .npm
          key: ${{ runner.os }}-health-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-health-
      
      - name: Install dependencies (fast)
        run: npm ci --prefer-offline --no-audit --progress=false || npm install --no-audit --progress=false
      
      - name: Install proxy dependency
        run: npm i -D http-proxy --no-save --no-audit
      
      - name: Run health checks
        env:
          API_PORT: 4400
          VITE_DEV_PORT: 8012
          PROXY_PORT: 9000
          ROOT_CHECK_PATH: /
          API_CHECK_PATH: /api/courses
        run: |
          nohup node server.js >/dev/null 2>&1 &  || true
          nohup vite --host 0.0.0.0 --port $VITE_DEV_PORT >/dev/null 2>&1 &  || true
          nohup node scripts/dev-proxy.js >/dev/null 2>&1 &  || true
          ./scripts/ci-health.sh
