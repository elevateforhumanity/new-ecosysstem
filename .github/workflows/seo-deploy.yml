name: Ultra-Tiny Chunk SEO Deploy

on:
  push:
    branches: [ main ]      # run on every change
  schedule:
    - cron: "0 6 * * *"     # nightly 06:00 UTC
  workflow_dispatch: {}

jobs:
  crawl-build-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Ultra-Tiny Chunk Crawl (1k URLs per sitemap)
        env:
          INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }}
        run: |
          echo "üîç Starting ultra-tiny chunk crawl (1k URLs per sitemap)..."
          npm run seo:crawl
          echo "üìä Crawl completed - generating month-based partitions"
          
          # Commit sitemap changes
          git config user.name "efh-bot"
          git config user.email "bot@elevateforhumanity.org"
          git add sites/marketing/sitemap_index.xml sites/marketing/sitemaps sites/marketing/robots.txt || true
          git commit -m "chore: ultra-tiny chunk sitemaps (1k URLs) - $(date '+%Y-%m-%d %H:%M')" || echo "no changes"
          git push || true

      - name: Deploy to Netlify (Marketing)
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: 'sites/marketing'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Ultra-Tiny Chunk SEO: ${{ github.event.head_commit.message }}"
          enable-pull-request-comment: false
          enable-commit-comment: true
          overwrites-pull-request-comment: false
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID_MARKETING }}

      - name: Verify Ultra-Tiny Chunk Deployment
        run: |
          echo "üåç Ultra-Tiny Chunk Enterprise SEO deployment completed!"
          echo "üìä Deployment details:"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Message: ${{ github.event.head_commit.message }}"
          echo "- Chunk Size: 1,000 URLs per sitemap (ultra-tiny for max Google performance)"
          echo "- Partitioning: Month-based with section organization"
          echo "- IndexNow: Instant search engine notifications"
          echo "- Search Engines: Google + Bing ping automation"
          echo "‚úÖ Ultra-Tiny Chunk Enterprise SEO system active"