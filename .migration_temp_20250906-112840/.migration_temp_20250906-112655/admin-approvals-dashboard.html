<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EFH ‚Äì Approvals Admin</title>
<style>
  :root{--max:1100px;--pad:20px;--r:12px;--ink:#111;--muted:#666;--line:#e3f2fd}
  *{box-sizing:border-box} 
  body{margin:0;font-family:system-ui,Arial,sans-serif;color:var(--ink);background:linear-gradient(135deg, #f8f9ff 0%, #e8f4fd 100%);min-height:100vh}
  header{position:sticky;top:0;background:linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);border-bottom:2px solid var(--line);z-index:10;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
  .wrap{max-width:var(--max);margin:0 auto;padding:20px var(--pad)}
  .brand{font-weight:900;color:#d32f2f;font-size:1.3em}
  .btn{padding:10px 16px;border:2px solid #1976d2;border-radius:12px;background:linear-gradient(135deg, #1976d2 0%, #1565c0 100%);color:white;cursor:pointer;font-weight:600;transition:all 0.2s;box-shadow:0 2px 4px rgba(25,118,210,0.3)}
  .btn:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(25,118,210,0.4)}
  .btn.danger{background:linear-gradient(135deg, #d32f2f 0%, #c62828 100%);border-color:#d32f2f;box-shadow:0 2px 4px rgba(211,47,47,0.3)}
  .btn.danger:hover{box-shadow:0 4px 8px rgba(211,47,47,0.4)}
  .muted{color:var(--muted)} 
  .input{padding:12px;border:2px solid var(--line);border-radius:10px;background:white;transition:border-color 0.2s}
  .input:focus{outline:none;border-color:#1976d2;box-shadow:0 0 0 3px rgba(25,118,210,0.1)}
  table{width:100%;border-collapse:collapse;background:white;border-radius:12px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  th,td{padding:15px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top;font-size:14px}
  th{font-weight:700;background:linear-gradient(135deg, #f8f9ff 0%, #e8f4fd 100%);color:#1976d2}
  .pill{padding:6px 12px;border-radius:999px;border:2px solid var(--line);font-size:12px;font-weight:600}
  .pill.pending{background:linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%);color:#856404;border-color:#ffeaa7} 
  .pill.approved{background:linear-gradient(135deg, #e9f9ef 0%, #d4edda 100%);color:#0a7b3e;border-color:#c3e6cb} 
  .pill.declined{background:linear-gradient(135deg, #fdeeee 0%, #f8d7da 100%);color:#721c24;border-color:#f5c6cb}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;gap:20px;grid-template-columns:1fr 1fr}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .card{border:2px solid var(--line);border-radius:12px;padding:20px;background:linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  .stat{font-size:28px;font-weight:700;margin-bottom:6px;color:#1976d2}
  .hero{background:linear-gradient(135deg, #d32f2f 0%, #c62828 100%);color:white;padding:30px;border-radius:12px;margin-bottom:30px;text-align:center}
  .hero h1{margin:0 0 10px 0;font-size:2.2em;font-weight:700}
  .hero p{margin:0;font-size:1.1em;opacity:0.9}
</style>
</head>
<body>
<!-- EFH Universal Header -->
<div id="efh-header"></div>

<header>
  <div class="wrap row" style="justify-content:space-between;align-items:center">
    <div class="brand">EFH ‚Ä¢ Approvals Admin</div>
    <div class="row">
      <input id="q" class="input" placeholder="Search email / slug / voucher‚Ä¶"/>
      <select id="status" class="input">
        <option value="">All Statuses</option>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="declined">Declined</option>
      </select>
      <button id="refresh" class="btn">Refresh</button>
      <button id="signout" class="btn">Sign out</button>
    </div>
  </div>
</header>

<main class="wrap" style="padding-top:14px">
  <!-- Hero Section -->
  <div class="hero">
    <h1>‚öôÔ∏è Admin Approvals Dashboard</h1>
    <p>Manage student applications, review funding requests, and oversee program enrollments</p>
  </div>

  <div id="gate" class="muted">Checking access‚Ä¶</div>

  <section id="panel" hidden>
    <p class="muted">Signed in as <span id="who"></span>. <strong id="role"></strong></p>

    <div class="grid" style="margin-bottom:20px">
      <div class="card">
        <h3 style="margin-top:0;color:#1976d2">üìä Quick Stats</h3>
        <div id="stats">
          <div>Pending: <span class="stat" id="stat-pending">0</span></div>
          <div>Approved: <span class="stat" id="stat-approved">0</span></div>
          <div>Declined: <span class="stat" id="stat-declined">0</span></div>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-top:0;color:#1976d2">üöÄ Quick Actions</h3>
        <div class="row">
          <button id="approve-all-pending" class="btn">‚úÖ Approve All Pending</button>
          <button id="export-data" class="btn">üìä Export Data</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Approval Requests</h3>
      <table id="tbl">
        <thead>
          <tr>
            <th>Student</th>
            <th>Program</th>
            <th>Voucher</th>
            <th>Case Manager</th>
            <th>Funding</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="7" class="muted">Loading‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </section>
</main>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // TODO: Replace with your actual values
  const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co';
  const SUPABASE_ANON_KEY = 'YOUR_PUBLIC_ANON_KEY';
  const PAY_ORIGIN = 'https://pay.elevateforhumanity.org';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { 
    auth: { persistSession: true, storage: localStorage } 
  });

  const gate = document.getElementById('gate');
  const panel = document.getElementById('panel');
  const who = document.getElementById('who');
  const role = document.getElementById('role');
  const rows = document.getElementById('rows');
  const stats = document.getElementById('stats');
  const q = document.getElementById('q');
  const status = document.getElementById('status');
  const refresh = document.getElementById('refresh');
  const signout = document.getElementById('signout');

  // Stats elements
  const statPending = document.getElementById('stat-pending');
  const statApproved = document.getElementById('stat-approved');
  const statDeclined = document.getElementById('stat-declined');

  async function isAdmin() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return { ok: false, reason: 'Not signed in' };
    who.textContent = user.email;

    // Check allowlist row exists for this email
    const { data, error } = await supabase
      .from('admin_emails')
      .select('email')
      .eq('email', user.email)
      .maybeSingle();
    
    if (error) return { ok: false, reason: error.message };
    if (!data) return { ok: false, reason: 'Not authorized' };
    return { ok: true };
  }

  async function signInIfNeeded() {
    const { data: { user } } = await supabase.auth.getUser();
    if (user) return user;
    
    const email = prompt('Admin email for magic link sign-in:');
    if (!email) return null;
    
    await supabase.auth.signInWithOtp({ email });
    alert('Check your email for the magic link, then reload this page.');
    return null;
  }

  async function loadApprovals() {
    try {
      const url = new URL(PAY_ORIGIN + '/api/approvals/list');
      if (q.value) url.searchParams.set('q', q.value.trim());
      if (status.value) url.searchParams.set('status', status.value);
      
      const r = await fetch(url.toString(), { credentials: 'include' });
      
      if (!r.ok) {
        rows.innerHTML = `<tr><td colspan="7">Could not load approvals. Ensure backend is running.</td></tr>`;
        return;
      }
      
      const data = await r.json();
      
      if (!Array.isArray(data) || !data.length) {
        rows.innerHTML = `<tr><td colspan="7" class="muted">No approvals found.</td></tr>`;
        updateStats([]);
        return;
      }

      rows.innerHTML = data.map(x => {
        const pill = `<span class="pill ${x.status}">${x.status}</span>`;
        const dt = new Date(x.created_at).toLocaleString();
        const dec = x.decided_at ? new Date(x.decided_at).toLocaleString() : '';
        
        return `<tr>
          <td>
            <div>${x.student_email}</div>
            <div class="muted" style="font-size:12px">${dt}</div>
          </td>
          <td>${x.program_slug}</td>
          <td>${x.voucher_id || '‚Äî'}</td>
          <td>${x.case_manager_email}</td>
          <td>${x.funding_source || '‚Äî'}</td>
          <td>
            ${pill}
            ${dec ? `<div class="muted" style="font-size:12px">${dec}</div>` : ''}
          </td>
          <td>
            ${x.status === 'pending' ? `
              <button class="btn" onclick="adminDecision('${x.id}','approved')" style="font-size:12px">Approve</button>
              <button class="btn" onclick="adminDecision('${x.id}','declined')" style="font-size:12px">Decline</button>
            ` : '<span class="muted">‚Äî</span>'}
          </td>
        </tr>`;
      }).join('');

      updateStats(data);
    } catch (e) {
      console.error('Load approvals error:', e);
      rows.innerHTML = `<tr><td colspan="7">Error loading data: ${e.message}</td></tr>`;
    }
  }

  function updateStats(data) {
    const counts = data.reduce((a, x) => { 
      a[x.status] = (a[x.status] || 0) + 1; 
      return a; 
    }, {});
    
    statPending.textContent = counts.pending || 0;
    statApproved.textContent = counts.approved || 0;
    statDeclined.textContent = counts.declined || 0;
  }

  // Global function for inline onclick handlers
  window.adminDecision = async (id, decision) => {
    const ok = confirm(`Confirm ${decision.toUpperCase()}?`);
    if (!ok) return;
    
    try {
      const r = await fetch(PAY_ORIGIN + '/api/approvals/admin_decide', {
        method: 'POST', 
        headers: {'Content-Type': 'application/json'},
        credentials: 'include',
        body: JSON.stringify({ id, decision })
      });
      
      if (!r.ok) { 
        alert('Failed to update approval'); 
        return; 
      }
      
      await loadApprovals();
    } catch (e) {
      console.error('Decision error:', e);
      alert('Error processing decision');
    }
  };

  // Event listeners
  refresh.addEventListener('click', loadApprovals);
  q.addEventListener('input', loadApprovals);
  status.addEventListener('change', loadApprovals);
  signout.addEventListener('click', async () => { 
    await supabase.auth.signOut(); 
    location.reload(); 
  });

  document.getElementById('approve-all-pending')?.addEventListener('click', async () => {
    const ok = confirm('Approve ALL pending requests? This cannot be undone.');
    if (!ok) return;
    
    // Get all pending
    const url = new URL(PAY_ORIGIN + '/api/approvals/list');
    url.searchParams.set('status', 'pending');
    const r = await fetch(url.toString(), { credentials: 'include' });
    const pending = await r.json();
    
    for (const item of pending) {
      await window.adminDecision(item.id, 'approved');
    }
  });

  document.getElementById('export-data')?.addEventListener('click', async () => {
    const url = new URL(PAY_ORIGIN + '/api/approvals/list');
    const r = await fetch(url.toString(), { credentials: 'include' });
    const data = await r.json();
    
    const csv = [
      'Student Email,Program,Voucher ID,Case Manager,Funding Source,Status,Created,Decided',
      ...data.map(x => [
        x.student_email,
        x.program_slug,
        x.voucher_id || '',
        x.case_manager_email,
        x.funding_source || '',
        x.status,
        x.created_at,
        x.decided_at || ''
      ].join(','))
    ].join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `efh-approvals-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  });

  // Initialize
  (async () => {
    const user = await signInIfNeeded(); // triggers magic link if not signed in
    const check = await isAdmin();
    
    if (!check.ok) { 
      gate.textContent = check.reason + ' (ask an admin to add your email to admin_emails table)'; 
      return; 
    }
    
    gate.remove(); 
    panel.hidden = false; 
    role.textContent = '(admin)';
    await loadApprovals();
  })();
</script>

<!-- Load Shared Components -->
<script src="shared/supabase.js"></script>
<script>
    // Load shared navigation and account drawer
    Promise.all([
        fetch('shared/navigation.html').then(r => r.text()),
        fetch('shared/account-drawer.html').then(r => r.text())
    ]).then(([navHtml, drawerHtml]) => {
        document.getElementById('shared-nav').innerHTML = navHtml;
        document.body.insertAdjacentHTML('beforeend', drawerHtml);
    });
</script>

<!-- EFH Universal Footer -->
<div id="efh-footer"></div>

<!-- Load Header/Footer -->
<script>
(async () => {
    try {
        const [headerRes, footerRes] = await Promise.all([
            fetch('/ui/header.html'),
            fetch('/ui/footer.html')
        ]);
        
        if (headerRes.ok) {
            const headerHTML = await headerRes.text();
            document.getElementById('efh-header').innerHTML = headerHTML;
        }
        
        if (footerRes.ok) {
            const footerHTML = await footerRes.text();
            document.getElementById('efh-footer').innerHTML = footerHTML;
        }
    } catch (error) {
        console.log('Header/footer loading failed:', error);
    }
})();
</script>

</body>
</html>