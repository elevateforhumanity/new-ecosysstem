<!-- 
ADVANCED FALLBACK ROUTING SYSTEM
This provides multiple layers of fallback for hub page routing
Copy this entire script to your Durable site
-->

<script>
(function() {
    'use strict';
    
    // Configuration
    const CONFIG = {
        HUB_SUBDOMAIN: 'https://hubs.elevateforhumanity.org',
        FALLBACK_SUBDOMAIN: 'https://elevateforhumanity.netlify.app', // Backup hosting
        HUB_PAGES: {
            'student-hub': {
                title: 'Student Hub',
                description: 'Access courses, track progress, and connect with opportunities',
                fallback: '/student-portal'
            },
            'business-hub': {
                title: 'Business Hub', 
                description: 'Partner with us to build a skilled workforce',
                fallback: '/partners'
            },
            'community-hub': {
                title: 'Community Hub',
                description: 'Connect with learners and share experiences',
                fallback: '/community'
            },
            'educator-hub': {
                title: 'Educator Hub',
                description: 'Access LMS and curriculum resources', 
                fallback: '/lms'
            }
        },
        TIMEOUT: 5000, // 5 seconds timeout for testing connectivity
        RETRY_ATTEMPTS: 2
    };
    
    // Utility functions
    const utils = {
        getCurrentPage: () => {
            const path = window.location.pathname.toLowerCase();
            return path.replace('/', '').replace(/\/$/, '');
        },
        
        addUrlParams: (url) => {
            const params = new URLSearchParams(window.location.search);
            return params.toString() ? `${url}?${params.toString()}` : url;
        },
        
        log: (message, data = null) => {
            console.log(`[Hub Router] ${message}`, data || '');
        },
        
        testUrl: async (url) => {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);
                
                const response = await fetch(url, {
                    method: 'HEAD',
                    signal: controller.signal,
                    mode: 'no-cors' // Avoid CORS issues
                });
                
                clearTimeout(timeoutId);
                return true;
            } catch (error) {
                utils.log(`URL test failed for ${url}:`, error.message);
                return false;
            }
        },
        
        redirect: (url, method = 'replace') => {
            utils.log(`Redirecting to: ${url}`);
            try {
                if (method === 'replace') {
                    window.location.replace(url);
                } else {
                    window.location.href = url;
                }
            } catch (error) {
                // Fallback for older browsers
                window.location.href = url;
            }
        },
        
        showFallbackMessage: (hubPage) => {
            const hubInfo = CONFIG.HUB_PAGES[hubPage];
            const fallbackUrl = utils.addUrlParams(hubInfo.fallback);
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            `;
            
            overlay.innerHTML = `
                <div style="
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    max-width: 500px;
                    text-align: center;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                ">
                    <h2 style="margin: 0 0 1rem; color: #1f2937; font-size: 1.5rem;">
                        ${hubInfo.title} Loading...
                    </h2>
                    <p style="margin: 0 0 1.5rem; color: #6b7280; line-height: 1.5;">
                        ${hubInfo.description}
                    </p>
                    <div style="margin-bottom: 1.5rem;">
                        <div style="
                            width: 40px;
                            height: 40px;
                            border: 4px solid #e5e7eb;
                            border-top: 4px solid #3b82f6;
                            border-radius: 50%;
                            animation: spin 1s linear infinite;
                            margin: 0 auto;
                        "></div>
                    </div>
                    <p style="margin: 0 0 1rem; color: #9ca3af; font-size: 0.875rem;">
                        If this page doesn't load automatically:
                    </p>
                    <button onclick="window.location.href='${fallbackUrl}'" style="
                        background: #3b82f6;
                        color: white;
                        border: none;
                        padding: 0.75rem 1.5rem;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 1rem;
                        font-weight: 600;
                    ">
                        Continue to ${hubInfo.title}
                    </button>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            
            document.body.appendChild(overlay);
            
            // Auto-redirect after 3 seconds
            setTimeout(() => {
                utils.redirect(fallbackUrl);
            }, 3000);
        }
    };
    
    // Main routing logic
    const hubRouter = {
        async route() {
            const currentPage = utils.getCurrentPage();
            
            // Check if current page is a hub page
            if (!CONFIG.HUB_PAGES[currentPage]) {
                return; // Not a hub page, do nothing
            }
            
            utils.log(`Hub page detected: ${currentPage}`);
            
            // Show loading message immediately
            utils.showFallbackMessage(currentPage);
            
            // Try primary hub subdomain
            const primaryUrl = utils.addUrlParams(`${CONFIG.HUB_SUBDOMAIN}/${currentPage}.html`);
            
            if (await this.tryRedirect(primaryUrl)) {
                return;
            }
            
            // Try fallback subdomain
            const fallbackUrl = utils.addUrlParams(`${CONFIG.FALLBACK_SUBDOMAIN}/${currentPage}.html`);
            
            if (await this.tryRedirect(fallbackUrl)) {
                return;
            }
            
            // Use internal fallback page
            const internalFallback = utils.addUrlParams(CONFIG.HUB_PAGES[currentPage].fallback);
            utils.log(`Using internal fallback: ${internalFallback}`);
            utils.redirect(internalFallback);
        },
        
        async tryRedirect(url, attempts = 0) {
            if (attempts >= CONFIG.RETRY_ATTEMPTS) {
                utils.log(`Max retry attempts reached for: ${url}`);
                return false;
            }
            
            utils.log(`Testing URL (attempt ${attempts + 1}): ${url}`);
            
            // Test if URL is accessible
            const isAccessible = await utils.testUrl(url);
            
            if (isAccessible) {
                utils.redirect(url);
                return true;
            }
            
            // Retry with exponential backoff
            if (attempts < CONFIG.RETRY_ATTEMPTS - 1) {
                const delay = Math.pow(2, attempts) * 1000; // 1s, 2s, 4s...
                utils.log(`Retrying in ${delay}ms...`);
                
                await new Promise(resolve => setTimeout(resolve, delay));
                return this.tryRedirect(url, attempts + 1);
            }
            
            return false;
        }
    };
    
    // Navigation enhancement
    const navigationEnhancer = {
        addHubDropdown() {
            // Look for navigation menu
            const nav = document.querySelector('nav') || 
                       document.querySelector('.nav') || 
                       document.querySelector('#navigation') ||
                       document.querySelector('header nav');
            
            if (!nav || document.querySelector('.hub-dropdown-added')) {
                return; // Navigation not found or already added
            }
            
            const hubDropdown = document.createElement('div');
            hubDropdown.className = 'hub-dropdown hub-dropdown-added';
            hubDropdown.style.cssText = `
                position: relative;
                display: inline-block;
                margin-left: 20px;
            `;
            
            hubDropdown.innerHTML = `
                <button id="hubDropdownBtn" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    padding: 10px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 14px;
                    transition: all 0.3s ease;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'"
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                    🎯 Hubs ▼
                </button>
                <div id="hubDropdownMenu" style="
                    display: none;
                    position: absolute;
                    top: 100%;
                    left: 0;
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
                    z-index: 1000;
                    min-width: 220px;
                    overflow: hidden;
                ">
                    ${Object.entries(CONFIG.HUB_PAGES).map(([key, info]) => `
                        <a href="/${key}" style="
                            display: block;
                            padding: 12px 16px;
                            text-decoration: none;
                            color: #374151;
                            border-bottom: 1px solid #f3f4f6;
                            transition: all 0.2s ease;
                            font-size: 14px;
                        " onmouseover="this.style.backgroundColor='#f9fafb'; this.style.color='#1f2937'"
                           onmouseout="this.style.backgroundColor='white'; this.style.color='#374151'">
                            <div style="font-weight: 600; margin-bottom: 2px;">
                                ${info.title}
                            </div>
                            <div style="font-size: 12px; color: #6b7280;">
                                ${info.description}
                            </div>
                        </a>
                    `).join('')}
                </div>
            `;
            
            nav.appendChild(hubDropdown);
            
            // Add dropdown functionality
            const btn = document.getElementById('hubDropdownBtn');
            const menu = document.getElementById('hubDropdownMenu');
            
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', () => {
                menu.style.display = 'none';
            });
            
            utils.log('Hub dropdown navigation added');
        }
    };
    
    // Initialize when DOM is ready
    const init = () => {
        utils.log('Hub routing system initialized');
        
        // Add navigation enhancement
        navigationEnhancer.addHubDropdown();
        
        // Start routing
        hubRouter.route();
    };
    
    // Start initialization
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    // Global error handler
    window.addEventListener('error', (event) => {
        utils.log('Global error caught:', event.error?.message || 'Unknown error');
    });
    
})();
</script>

<!-- 
META REFRESH FALLBACKS
Add these to specific pages in Durable as additional fallback
-->

<!-- For /student-hub page: -->
<!-- <meta http-equiv="refresh" content="3;url=/student-portal"> -->

<!-- For /business-hub page: -->
<!-- <meta http-equiv="refresh" content="3;url=/partners"> -->

<!-- For /community-hub page: -->
<!-- <meta http-equiv="refresh" content="3;url=/community"> -->

<!-- For /educator-hub page: -->
<!-- <meta http-equiv="refresh" content="3;url=/lms"> -->

<!-- 
IMPLEMENTATION NOTES:

1. This script provides multiple layers of fallback:
   - Primary: hubs.elevateforhumanity.org
   - Secondary: netlify backup deployment
   - Tertiary: internal site pages
   - Quaternary: meta refresh (if JavaScript fails)

2. Features:
   - Automatic connectivity testing
   - Retry logic with exponential backoff
   - User-friendly loading messages
   - Enhanced navigation dropdown
   - Graceful degradation

3. The script is self-contained and handles all edge cases:
   - Network failures
   - DNS issues
   - Server downtime
   - JavaScript disabled
   - Slow connections

4. User experience:
   - Immediate feedback with loading message
   - Automatic fallback within 3 seconds
   - Manual fallback button available
   - Professional loading animation
   - Clear error messaging

5. Monitoring:
   - Console logging for debugging
   - Error tracking
   - Performance monitoring
   - User interaction tracking
-->