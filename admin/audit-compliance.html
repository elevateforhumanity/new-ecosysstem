<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self' https:; frame-ancestors 'none';">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Trail & Compliance Logging - DOL/DWD System</title>
    <meta name="description" content="Federal audit trail and compliance logging system for workforce development oversight">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="scripts/efh-universal.v2.2.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Audit and Compliance Functions
        let currentPage = 1;
        let totalPages = 1;

        async function loadAuditLogs() {
            try {
                const response = await fetch('/api/compliance/audit-logs?limit=50');
                const data = await response.json();
                displayAuditLogs(data.audit_logs || []);
                document.getElementById('logs-count').textContent = data.audit_logs?.length || 0;
            } catch (error) {
                console.error('Error loading audit logs:', error);
            }
        }

        async function loadFederalAPILogs() {
            try {
                const response = await fetch('/api/compliance/federal-api-logs?limit=25');
                const data = await response.json();
                displayAPILogs(data.api_logs || []);
            } catch (error) {
                console.error('Error loading API logs:', error);
            }
        }

        function displayAuditLogs(logs) {
            const tbody = document.getElementById('audit-logs-table-body');
            tbody.innerHTML = '';

            logs.forEach(log => {
                const details = log.action_details || {};
                const detailsText = Object.keys(details).map(key => `${key}: ${details[key]}`).join(', ');

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${new Date(log.created_at).toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getActionColor(action) {
            switch(action) {
                case 'create': return 'bg-green-100 text-green-800';
                case 'update': return 'bg-blue-100 text-blue-800';
                case 'delete': return 'bg-red-100 text-red-800';
                case 'submit': return 'bg-purple-100 text-purple-800';
                case 'approve': return 'bg-emerald-100 text-emerald-800';
                case 'verify': return 'bg-orange-100 text-orange-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusColor(status) {
            if (status === 'success' || status?.toString().startsWith('2')) {
                return 'bg-green-100 text-green-800';
            } else if (status?.toString().startsWith('4')) {
                return 'bg-yellow-100 text-yellow-800';
            } else if (status?.toString().startsWith('5')) {
                return 'bg-red-100 text-red-800';
            }
            return 'bg-gray-100 text-gray-800';
        }

        function filterAuditLogs() {
            const action = document.getElementById('action-filter').value;
            const resource = document.getElementById('resource-filter').value;
            const date = document.getElementById('date-filter').value;
            
            // Build query parameters
            const params = new URLSearchParams();
            if (action) params.append('action_type', action);
            if (resource) params.append('resource_type', resource);
            if (date) params.append('date', date);
            params.append('limit', '50');
            
            // Reload with filters
            loadAuditLogsWithParams(params.toString());
        }

        async function loadAuditLogsWithParams(queryString) {
            try {
                const response = await fetch(`/api/compliance/audit-logs?${queryString}`);
                const data = await response.json();
                displayAuditLogs(data.audit_logs || []);
                document.getElementById('logs-count').textContent = data.audit_logs?.length || 0;
            } catch (error) {
                console.error('Error loading filtered audit logs:', error);
            }
        }

        function generateAuditReport() {
            const reportData = {
                total_events: document.getElementById('total-events').textContent,
                critical_alerts: document.getElementById('critical-alerts').textContent,
                compliance_score: document.getElementById('compliance-score').textContent,
                period: 'Q4 2024',
                generated_at: new Date().toISOString()
            };
            
            // In real implementation, this would generate a downloadable PDF/Excel report
            alert('Generating comprehensive audit report for federal submission...\n\n' +
                  `Period: Q4 2024\n` +
                  `Total Events: ${reportData.total_events}\n` +
                  `Critical Alerts: ${reportData.critical_alerts}\n` +
                  `Compliance Score: ${reportData.compliance_score}`);
        }

        function showComplianceCheck() {
            alert('Running comprehensive compliance check...\n\n' +
                  '✅ PIRL Data Integrity: PASSED\n' +
                  '✅ Eligibility Documentation: PASSED\n' +
                  '✅ Performance Tracking: PASSED\n' +
                  '✅ Audit Trail Completeness: PASSED\n' +
                  '⚠️  Performance Targets: 2 indicators below target\n' +
                  '✅ Federal API Connectivity: PASSED\n\n' +
                  'Overall Compliance Score: 98.7%');
        }

        function exportLogs() {
            alert('Exporting audit logs for federal review...\n\n' +
                  'Available formats:\n' +
                  '• CSV for data analysis\n' +
                  '• PDF for official submission\n' +
                  '• JSON for system integration\n\n' +
                  'Logs include full audit trail with federal compliance markers.');
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                document.getElementById('current-page').textContent = currentPage;
                loadAuditLogs();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                document.getElementById('current-page').textContent = currentPage;
                loadAuditLogs();
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAuditLogs();
            loadFederalAPILogs();
        });
    </script>
</body>
</html>