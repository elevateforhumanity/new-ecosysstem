import React, { useEffect, useState } from "react";
import { BrowserRouter, Routes, Route, Link, Navigate } from "react-router-dom";

/*
  EFH Router App (React + Tailwind)
  -------------------------------------------------
  - Drop this into client/src/App.tsx
  - Run: npm i react-router-dom
  - Ensure main.tsx renders <App />
  - Server must SPA-fallback to index.html (your server.mjs already does)

  Humanized: Clean navigation, clear page sections, easy to read.
*/

// Badge that confirms Tailwind loaded and reports to the server
function TailwindCheck() {
  const [ok, setOk] = useState(true);

  useEffect(() => {
    const test = document.createElement("div");
    test.className = "hidden"; // Tailwind sets display:none
    document.body.appendChild(test);
    const computed = window.getComputedStyle(test).display;
    document.body.removeChild(test);

    const tailwindOk = computed === "none";
    setOk(tailwindOk);

    fetch("/_telemetry", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ tailwindOk }),
    }).catch(() => {});
  }, []);

  return ok ? (
    <div className="fixed bottom-3 right-3 z-50 text-xs bg-green-600 text-white px-2 py-1 rounded-md shadow-md">
      Tailwind OK
    </div>
  ) : (
    <div className="fixed bottom-3 right-3 z-50 text-xs bg-red-600 text-white px-2 py-1 rounded-md shadow-md">
      Tailwind NOT loaded
    </div>
  );
}

function Navbar() {
  return (
    <header className="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
      <div className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div className="flex h-16 items-center justify-between">
          <Link to="/" className="flex items-center gap-2">
            <span className="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-indigo-600 text-white font-bold">EFH</span>
            <span className="font-semibold tracking-tight">Elevate for Humanity</span>
          </Link>
          <nav className="hidden md:flex items-center gap-6 text-sm">
            <Link to="/hub" className="hover:text-indigo-600">Hub</Link>
            <Link to="/programs" className="hover:text-indigo-600">Programs</Link>
            <Link to="/lms" className="hover:text-indigo-600">LMS</Link>
            <Link to="/connect" className="hover:text-indigo-600">Connect</Link>
            <Link to="/pay" className="hover:text-indigo-600">Pay</Link>
            <Link to="/compliance" className="hover:text-indigo-600">Compliance</Link>
            <Link to="/debug" className="text-slate-500 hover:text-indigo-600">Debug</Link>
          </nav>
          <div className="hidden md:flex items-center gap-3">
            <Link to="/apply" className="inline-flex items-center rounded-xl border border-slate-300 px-3 py-2 text-sm font-medium hover:bg-slate-50">Apply</Link>
            <Link to="/partners" className="inline-flex items-center rounded-xl bg-indigo-600 text-white px-3 py-2 text-sm font-medium hover:bg-indigo-700">Partner</Link>
          </div>
        </div>
      </div>
    </header>
  );
}

function Shell({ children }: { children: React.ReactNode }) {
  return (
    <div className="min-h-screen bg-white text-slate-900 flex flex-col">
      <div className="w-full bg-indigo-50 text-indigo-700 text-sm py-2 px-4 text-center">
        Elevate for Humanity · Workforce Development & Training Institute
      </div>
      <Navbar />
      <main className="flex-grow">{children}</main>
      <footer className="border-t border-slate-200 py-10 mt-10">
        <div className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 grid md:grid-cols-3 gap-8 text-sm">
          <div>
            <div className="flex items-center gap-2">
              <span className="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-indigo-600 text-white font-bold">EFH</span>
              <span className="font-semibold">Elevate for Humanity</span>
            </div>
            <p className="mt-3 text-slate-600">Workforce hub · Indianapolis, IN · Multi-site expansion.</p>
          </div>
          <div>
            <h4 className="font-semibold">Quick Links</h4>
            <ul className="mt-2 space-y-2">
              <li><Link to="/apply" className="hover:text-indigo-600">Apply</Link></li>
              <li><Link to="/programs" className="hover:text-indigo-600">Programs</Link></li>
              <li><Link to="/lms" className="hover:text-indigo-600">LMS</Link></li>
              <li><Link to="/connect" className="hover:text-indigo-600">Contact</Link></li>
              <li><Link to="/debug" className="text-slate-500 hover:text-indigo-600">Debug</Link></li>
            </ul>
          </div>
          <div>
            <h4 className="font-semibold">Contact</h4>
            <p className="mt-2 text-slate-600">7009 E 56th St, Suite F · Indianapolis, IN</p>
            <p className="text-slate-600">(XXX) XXX-XXXX · info@elevateforhumanity.org</p>
          </div>
        </div>
        <p className="mt-8 text-center text-xs text-slate-500">© {new Date().getFullYear()} Elevate for Humanity. All rights reserved.</p>
      </footer>
      <TailwindCheck />
    </div>
  );
}

// --- Pages ---
function Home() {
  return (
    <section className="relative overflow-hidden">
      <div className="absolute inset-0 -z-10 bg-gradient-to-b from-white via-indigo-50 to-white" />
      <div className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-16 lg:py-24 grid lg:grid-cols-2 gap-10 items-center">
        <div>
          <h1 className="text-4xl sm:text-5xl font-extrabold tracking-tight leading-tight">
            Workforce Development Ecosystem
          </h1>
          <p className="mt-5 text-lg text-slate-700 max-w-xl">
            Career pathways, apprenticeships, and industry credentials for youth and adults — aligned to state & federal funding streams and employer needs across Indiana and beyond.
          </p>
          <div className="mt-8 flex flex-wrap gap-3">
            <Link to="/programs" className="inline-flex items-center rounded-2xl bg-indigo-600 text-white px-5 py-3 font-medium shadow-sm hover:bg-indigo-700">Explore Programs</Link>
            <Link to="/partners" className="inline-flex items-center rounded-2xl border border-slate-300 px-5 py-3 font-medium hover:bg-slate-50">Partner With Us</Link>
            <Link to="/pay" className="inline-flex items-center rounded-2xl border border-slate-300 px-5 py-3 font-medium hover:bg-slate-50">Pay Tuition</Link>
          </div>
          <dl className="mt-10 grid grid-cols-2 sm:grid-cols-4 gap-6 max-w-2xl">
            <div className="rounded-2xl border border-slate-200 p-4">
              <dt className="text-xs text-slate-500">Approved & Compliant</dt>
              <dd className="mt-1 text-2xl font-semibold">DOL · DWD</dd>
            </div>
            <div className="rounded-2xl border border-slate-200 p-4">
              <dt className="text-xs text-slate-500">Funding Pathways</dt>
              <dd className="mt-1 text-2xl font-semibold">WIOA · JRI · WRG</dd>
            </div>
            <div className="rounded-2xl border border-slate-200 p-4">
              <dt className="text-xs text-slate-500">Programs</dt>
              <dd className="mt-1 text-2xl font-semibold">CPR · Barber · Esthetics · DSP · Tech</dd>
            </div>
            <div className="rounded-2xl border border-slate-200 p-4">
              <dt className="text-xs text-slate-500">Reach</dt>
              <dd className="mt-1 text-2xl font-semibold">Indiana · Multi-state</dd>
            </div>
          </dl>
        </div>
        <div className="relative">
          <div className="rounded-3xl border border-slate-200 shadow-sm p-6 bg-white">
            <h3 className="text-xl font-semibold">Get Started</h3>
            <p className="mt-2 text-slate-600">We’ll guide you step-by-step from enrollment to certification and job placement.</p>
            <ul className="mt-4 space-y-3 text-sm">
              <li className="flex items-start gap-3"><span className="mt-1 inline-flex h-5 w-5 items-center justify-center rounded-full bg-indigo-600 text-white text-[10px]">1</span> Apply for funding (WIOA/JRI/WRG)</li>
              <li className="flex items-start gap-3"><span className="mt-1 inline-flex h-5 w-5 items-center justify-center rounded-full bg-indigo-600 text-white text-[10px]">2</span> Enroll in programs using our LMS</li>
              <li className="flex items-start gap-3"><span className="mt-1 inline-flex h-5 w-5 items-center justify-center rounded-full bg-indigo-600 text-white text-[10px]">3</span> Complete credentials & connect with employers</li>
            </ul>
            <Link to="/apply" className="mt-6 inline-flex w-full items-center justify-center rounded-2xl bg-indigo-600 px-5 py-3 font-medium text-white hover:bg-indigo-700">Start Application</Link>
            <p className="mt-3 text-xs text-slate-500">Questions? <Link className="underline" to="/connect">Contact our team</Link>.</p>
          </div>
        </div>
      </div>
    </section>
  );
}

function Page({ title, children }: { title: string; children?: React.ReactNode }) {
  return (
    <section className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10">
      <h1 className="text-3xl font-bold tracking-tight">{title}</h1>
      <div className="mt-4 text-slate-700 leading-relaxed">{children}</div>
    </section>
  );
}

const Hub = () => <Page title="Hub">Stay updated with news, dashboards, and quick resources.</Page>;
const Programs = () => <Page title="Programs">Browse our full program catalog with details on funding eligibility.</Page>;
const LMS = () => <Page title="LMS">Login to your courses, track certifications, and monitor progress.</Page>;
const Connect = () => <Page title="Connect">Reach out through our contact form, explore the directory, or begin a partner intake.</Page>;
const Pay = () => <Page title="Pay">Secure payment links (Stripe) and invoices for tuition and services.</Page>;
const Compliance = () => <Page title="Compliance">Access policies, DOL/DWD documentation, and reporting portals.</Page>;
const Apply = () => <Page title="Apply">Submit your student application, upload documents, and choose funding options.</Page>;
const Partners = () => <Page title="Partners">Learn about partnering with EFH: WEX/OJT reimbursements, revenue-share models, and more.</Page>;

// NEW: Debug page that reads /health from the server
function Debug() {
  const [data, setData] = useState<any>(null);
  const [err, setErr] = useState<string | null>(null);
  const [token, setToken] = useState("");
  const [restartMsg, setRestartMsg] = useState<string | null>(null);

  useEffect(() => {
    fetch("/health")
      .then(r => r.json())
      .then(setData)
      .catch(e => setErr(String(e)));
  }, []);

  const triggerRestart = async () => {
    setRestartMsg(null);
    try {
      const res = await fetch("/_restart", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Admin-Token": token.trim(),
        },
        body: JSON.stringify({ reason: "manual from /debug" }),
      });
      const json = await res.json().catch(() => ({}));
      if (!res.ok) {
        setRestartMsg(`Failed (${res.status}): ${json?.error || "Unauthorized or server error"}`);
      } else {
        setRestartMsg("Restart requested. The server may go offline briefly and come back.");
      }
    } catch (e:any) {
      setRestartMsg(`Error: ${e.message}`);
    }
  };

  return (
    <Page title="Debug / Health">
      <div className="grid md:grid-cols-2 gap-6">
        <div className="rounded-2xl border border-slate-200 p-4">
          <h3 className="font-semibold">Server Health</h3>
          {err && <p className="text-red-600 text-sm mt-2">{err}</p>}
          {!data && !err && <p className="text-slate-500 text-sm mt-2">Loading…</p>}
          {data && (
            <ul className="mt-3 text-sm space-y-2">
              <li><span className="text-slate-500">status:</span> {String(data.status)}</li>
              <li><span className="text-slate-500">mode:</span> {String(data.mode)}</li>
              <li><span className="text-slate-500">timestamp:</span> {String(data.timestamp)}</li>
              <li><span className="text-slate-500">port:</span> {String(data.port)}</li>
              <li><span className="text-slate-500">tailwind.ok:</span> {String(data.tailwind?.ok)}</li>
              <li><span className="text-slate-500">tailwind.lastPingIso:</span> {String(data.tailwind?.lastPingIso)}</li>
            </ul>
          )}
        </div>
        <div className="rounded-2xl border border-slate-200 p-4">
          <h3 className="font-semibold">Client Checks</h3>
          <p className="text-sm text-slate-600 mt-2">
            The floating badge shows whether Tailwind is active. If it says "NOT loaded", run the client clean build.
          </p>
          <ol className="mt-3 list-decimal list-inside text-sm space-y-1 text-slate-700">
            <li>Open DevTools → Network → confirm CSS is loaded (no 404).
            </li>
            <li>Run <code>npm run quick</code> for fast rebuild or <code>npm run clean</code> for full reset.
            </li>
            <li>Reload the page and re-check the green badge.
            </li>
          </ol>
        </div>
        <div className="rounded-2xl border border-amber-300 p-4 bg-amber-50 md:col-span-2">
          <h3 className=\"font-semibold\">Admin: Restart Server</h3>
          <p className=\"text-sm text-amber-800 mt-1\">Protected action. Requires the admin token set on the server. Use only if a rebuild didn’t pick up changes or the server is stuck.</p>
          <div className=\"mt-3 flex flex-col sm:flex-row gap-3\">
            <input
              type=\"password\"
              placeholder=\"Enter admin token\"
              value={token}
              onChange={(e) => setToken(e.target.value)}
              className=\"w-full sm:max-w-xs rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500\"
            />
            <button onClick={triggerRestart} className=\"inline-flex items-center rounded-lg bg-indigo-600 text-white px-4 py-2 text-sm font-medium hover:bg-indigo-700\">
              Request Restart
            </button>
          </div>
          {restartMsg && <p className=\"mt-2 text-sm\">{restartMsg}</p>}
        </div>

        {/* Admin: Purge caches */}
        <div className=\"rounded-2xl border border-emerald-300 p-4 bg-emerald-50 md:col-span-2\">
          <h3 className=\"font-semibold\">Admin: Purge Cache</h3>
          <p className=\"text-sm text-emerald-800 mt-1\">Two options: (1) purge this browser’s local caches; (2) hit the protected server endpoint to bump cache version.</p>
          <div className=\"mt-3 flex flex-col gap-3 sm:flex-row\">
            <button
              onClick={() => {
                // Local purge: SW + Cache Storage + Storage
                const purge = async () => {
                  try {
                    if ('serviceWorker' in navigator) {
                      const regs = await navigator.serviceWorker.getRegistrations();
                      await Promise.all(regs.map(r => r.unregister()));
                    }
                    if ('caches' in window) {
                      const keys = await caches.keys();
                      await Promise.all(keys.map(k => caches.delete(k)));
                    }
                    localStorage.clear();
                    sessionStorage.clear();
                    alert('Local caches cleared. Reloading…');
                    location.reload();
                  } catch (e) {
                    alert('Local purge error: ' + (e?.message || e));
                  }
                };
                purge();
              }}
              className=\"inline-flex items-center rounded-lg bg-emerald-600 text-white px-4 py-2 text-sm font-medium hover:bg-emerald-700\"
            >
              Purge Local Cache (this browser)
            </button>

            <button
              onClick={async () => {
                try {
                  const res = await fetch('/_purge', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'X-Admin-Token': token.trim(),
                    },
                    body: JSON.stringify({ reason: 'manual from /debug' })
                  });
                  const json = await res.json().catch(() => ({}));
                  if (!res.ok) {
                    alert(`Server purge failed (${res.status}): ${json?.error || 'Unauthorized or server error'}`);
                  } else {
                    alert('Server cache version bumped. Reloading…');
                    location.reload();
                  }
                } catch (e) {
                  alert('Server purge error: ' + (e?.message || e));
                }
              }}
              className=\"inline-flex items-center rounded-lg bg-teal-600 text-white px-4 py-2 text-sm font-medium hover:bg-teal-700\"
            >
              Purge Server Cache (requires token)
            </button>
          </div>
        </div>
      </div>
    </Page>
  );
}
          {!data && !err && <p className="text-slate-500 text-sm mt-2">Loading…</p>}
          {data && (
            <ul className="mt-3 text-sm space-y-2">
              <li><span className="text-slate-500">status:</span> {String(data.status)}</li>
              <li><span className="text-slate-500">mode:</span> {String(data.mode)}</li>
              <li><span className="text-slate-500">timestamp:</span> {String(data.timestamp)}</li>
              <li><span className="text-slate-500">port:</span> {String(data.port)}</li>
              <li><span className="text-slate-500">tailwind.ok:</span> {String(data.tailwind?.ok)}</li>
              <li><span className="text-slate-500">tailwind.lastPingIso:</span> {String(data.tailwind?.lastPingIso)}</li>
            </ul>
          )}
        </div>
        <div className="rounded-2xl border border-slate-200 p-4">
          <h3 className="font-semibold">Client Checks</h3>
          <p className="text-sm text-slate-600 mt-2">
            The floating badge shows whether Tailwind is active. If it says "NOT loaded", run the client clean build.
          </p>
          <ol className="mt-3 list-decimal list-inside text-sm space-y-1 text-slate-700">
            <li>Open DevTools → Network → confirm CSS is loaded (no 404).</li>
            <li>Run <code>npm run quick</code> for fast rebuild or <code>npm run clean</code> for full reset.</li>
            <li>Reload the page and re-check the green badge.</li>
          </ol>
        </div>
      </div>
    </Page>
  );
}

const NotFound = () => (
  <Page title="Page not found">
    We couldn't find that page. <Link to="/" className="text-indigo-700 underline">Go back home</Link>.
  </Page>
);

// Small badge that shows server cacheVersion & mode
function HealthBadge() {
  const [info, setInfo] = useState<{ cacheVersion?: number; mode?: string } | null>(null);

  useEffect(() => {
    let alive = true;
    const load = async () => {
      try {
        const r = await fetch("/health", { cache: "no-store" });
        const j = await r.json();
        if (alive) setInfo({ cacheVersion: j.cacheVersion, mode: j.mode });
      } catch {}
    };
    load();
    const id = setInterval(load, 30000); // refresh every 30s
    return () => { alive = false; clearInterval(id); };
  }, []);

  if (!info) return null;
  return (
    <div className="mt-4 flex items-center justify-center">
      <span className="inline-flex items-center gap-2 rounded-md border border-slate-200 bg-slate-50 px-3 py-1 text-xs text-slate-600">
        <span className="h-2 w-2 rounded-full bg-emerald-500" />
        cache v{info.cacheVersion} · {info.mode}
      </span>
    </div>
  );
}

export default function App() {
  return (
    <BrowserRouter>
      <Shell>
        <Routes>
          <Route path="/" element={<Home />} />
          <Route path="/hub" element={<Hub />} />
          <Route path="/programs" element={<Programs />} />
          <Route path="/lms" element={<LMS />} />
          <Route path="/connect" element={<Connect />} />
          <Route path="/pay" element={<Pay />} />
          <Route path="/compliance" element={<Compliance />} />
          <Route path="/apply" element={<Apply />} />
          <Route path="/partners" element={<Partners />} />
          <Route path="/debug" element={<Debug />} />
          <Route path="/main" element={<Navigate to="/" replace />} />
          <Route path="*" element={<NotFound />} />
        </Routes>
        <HealthBadge />
      </Shell>
    </BrowserRouter>
  );
}


Added a small cache version badge in the footer area. It fetches /health, shows cache v<timestamp> · <mode> (e.g., cache v1725212345678 · quick), and refreshes every 30s.

If you want it fixed to the bottom-left like the Tailwind badge, I can pin it there instead.

