<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSP Testing Tool</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; report-uri /api/csp-report;">
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        .test-section { margin: 2rem 0; padding: 1rem; border: 1px solid #ccc; }
        .pass { color: green; }
        .fail { color: red; }
        .violation { background: #ffe6e6; padding: 0.5rem; margin: 0.5rem 0; }
    </style>
</head>
<body>
    <h1>CSP Testing Tool</h1>
    
    <div class="test-section">
        <h2>Inline Script Test</h2>
        <p id="inline-script-result">Testing...</p>
        <script>
            document.getElementById('inline-script-result').textContent = 'Inline script executed (should be blocked in strict CSP)';
            document.getElementById('inline-script-result').className = 'fail';
        </script>
    </div>
    
    <div class="test-section">
        <h2>External Script Test</h2>
        <p id="external-script-result">Testing external script...</p>
        <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
        <script>
            if (typeof _ !== 'undefined') {
                document.getElementById('external-script-result').textContent = 'External script loaded (should be blocked in strict CSP)';
                document.getElementById('external-script-result').className = 'fail';
            } else {
                document.getElementById('external-script-result').textContent = 'External script blocked';
                document.getElementById('external-script-result').className = 'pass';
            }
        </script>
    </div>
    
    <div class="test-section">
        <h2>Inline Style Test</h2>
        <p style="color: red; font-weight: bold;">This text should be red and bold (inline style)</p>
        <p>If the text above is styled, inline styles are allowed</p>
    </div>
    
    <div class="test-section">
        <h2>Image Source Test</h2>
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzAwZiIgLz4KICA8dGV4dCB4PSI1MCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VGVzdDwvdGV4dD4KPC9zdmc+" alt="Data URI Image" style="width: 100px; height: 100px;">
        <p>Data URI image test (should be allowed)</p>
    </div>
    
    <div class="test-section">
        <h2>Frame Test</h2>
        <iframe src="about:blank" width="300" height="200"></iframe>
        <p>If you see a frame above, frame-src is allowed</p>
    </div>
    
    <div class="test-section">
        <h2>CSP Violations Log</h2>
        <div id="violations-log">
            <p>Checking for violations...</p>
        </div>
        <button onclick="loadViolations()">Refresh Violations</button>
    </div>
    
    <script>
        // Load CSP violations
        function loadViolations() {
            fetch('/api/csp-violations')
                .then(response => response.json())
                .then(data => {
                    const log = document.getElementById('violations-log');
                    if (data.violations && data.violations.length > 0) {
                        log.innerHTML = '<h3>Recent Violations:</h3>' + 
                            data.violations.slice(-10).map(v => 
                                `<div class="violation">
                                    <strong>${new Date(v.timestamp).toLocaleString()}</strong><br>
                                    Blocked URI: ${v.violation['csp-report']['blocked-uri']}<br>
                                    Violated Directive: ${v.violation['csp-report']['violated-directive']}
                                </div>`
                            ).join('');
                    } else {
                        log.innerHTML = '<p class="pass">No violations found</p>';
                    }
                })
                .catch(err => {
                    document.getElementById('violations-log').innerHTML = '<p class="fail">Error loading violations: ' + err.message + '</p>';
                });
        }
        
        // Load violations on page load
        setTimeout(loadViolations, 1000);
    </script>
</body>
</html>