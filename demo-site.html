<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>AI Training Demo | Free Course Preview | Elevate for Humanity | Try Before You Buy</title>
    <meta name="title" content="AI Training Demo | Free Course Preview | Elevate for Humanity | Try Before You Buy">
    <meta name="description" content="Experience our AI and data science training with a free demo. See real course content, interactive assignments, and learning platform features. No commitment required - start your free trial today!">
    <meta name="keywords" content="AI course demo, free data science trial, machine learning preview, coding bootcamp demo, online education trial, AI training sample, data science course preview, programming bootcamp trial">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://your-domain.replit.app/demo-site.html">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-domain.replit.app/demo-site.html">
    <meta property="og:title" content="AI Training Demo | Free Course Preview">
    <meta property="og:description" content="Experience our AI and data science training with a free demo. See real course content and interactive assignments.">
    <meta property="og:image" content="https://your-domain.replit.app/assets/demo-og.jpg">
    <meta property="og:site_name" content="Elevate for Humanity">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://your-domain.replit.app/demo-site.html">
    <meta property="twitter:title" content="AI Training Demo | Free Course Preview">
    <meta property="twitter:description" content="Experience our AI and data science training with a free demo. See real course content and interactive assignments.">
    <meta property="twitter:image" content="https://your-domain.replit.app/assets/demo-twitter.jpg">
    
    <!-- Security & Performance -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <meta name="googlebot" content="index, follow">
    <meta name="bingbot" content="index, follow">
    
    <!-- Structured Data for Demo -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Elevate for Humanity Course Demo",
      "description": "Free demo of AI and data science training platform",
      "url": "https://your-domain.replit.app/demo-site.html",
      "applicationCategory": "EducationalApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD",
        "description": "Free trial of AI and data science courses"
      },
      "featureList": [
        "Interactive Course Content",
        "Code Playground",
        "Video Lessons",
        "Real Assignments",
        "Progress Tracking"
      ]
    }
    </script>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'GA_MEASUREMENT_ID');
      gtag('event', 'page_view', {
        page_title: 'Course Demo',
        page_location: window.location.href
      });
    </script>
    <style>
        body { 
            font-family: system-ui, Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            line-height: 1.6;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 40px;
        }
        .nav a {
            margin-left: 20px;
            text-decoration: none;
            color: #333;
            padding: 8px 16px;
            border: 1px solid #333;
            border-radius: 12px;
        }
        .enroll-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .program-card {
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <!-- EFH Universal Header -->
    <div id="efh-header"></div>
    
    <div class="container">
        <header class="header">
            <h1>Elevate for Humanity - Payment System</h1>
            <nav class="nav">
                <a href="hub.html">Hub</a>
                <a href="programs.html">Programs</a>
                <a href="lms.html">LMS</a>
                <a href="connect.html">Connect</a>
                <a href="account.html">Account</a>
            </nav>
        </header>

        <main id="programs">
            <h2>Available Programs</h2>
            
            <!-- Test Coupon Hint -->
            <div style="background:linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);border:2px solid #ff9800;border-radius:12px;padding:20px;margin:20px 0;text-align:center">
                <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:8px">
                    <span style="font-size:24px">🎯</span>
                    <span style="font-size:18px;font-weight:700;color:#e65100">Test These Coupon Codes</span>
                </div>
                <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center">
                    <span style="background:white;padding:8px 12px;border-radius:6px;border:1px solid #ff9800;font-weight:600;color:#e65100">SAVE10</span>
                    <span style="background:white;padding:8px 12px;border-radius:6px;border:1px solid #ff9800;font-weight:600;color:#e65100">WIOA2025</span>
                    <span style="background:white;padding:8px 12px;border-radius:6px;border:1px solid #ff9800;font-weight:600;color:#e65100">FREECPR</span>
                    <span style="background:white;padding:8px 12px;border-radius:6px;border:1px solid #ff9800;font-weight:600;color:#e65100">NEWSTUDENT</span>
                </div>
            </div>
            
            <div class="program-card" data-program="business">
                <h3>Business Startup & Marketing</h3>
                <p>Comprehensive program covering business fundamentals, startup strategies, and marketing techniques.</p>
                <p><strong>Investment: $4,950</strong></p>
                
                <!-- Coupon Field -->
                <div style="margin-top:20px;padding:20px;border:2px solid #e3f2fd;border-radius:12px;background:linear-gradient(135deg, #f8f9ff 0%, #e8f4fd 100%)">
                    <div style="display:flex;align-items:center;margin-bottom:12px">
                        <span style="font-size:20px;margin-right:8px">🎫</span>
                        <label style="font-weight:700;color:#1976d2;font-size:16px">Have a coupon code?</label>
                    </div>
                    <div style="display:flex;gap:10px;margin-bottom:12px">
                        <input id="cp_business" type="text" placeholder="Try: SAVE10, WIOA2025" 
                               style="flex:1;padding:12px;border:2px solid #bbdefb;border-radius:8px;font-size:16px;background:white"/>
                        <button onclick="applyCoupon('business')" 
                                style="padding:12px 20px;background:#1976d2;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 2px 4px rgba(25,118,210,0.3)">
                            Apply
                        </button>
                    </div>
                    <div id="cpout_business" style="font-size:15px;font-weight:500;min-height:24px;padding:8px;border-radius:6px"></div>
                </div>
                
                <button class="enroll-btn" onclick="efhEnroll({ 
                    programName:'Business Startup & Marketing', 
                    amountUSD:4950 
                })">Enroll Now - $4,950</button>
            </div>

            <div class="program-card" data-program="cpr-ems">
                <h3>CPR / EMS Safety Technician</h3>
                <p>Essential life-saving skills and emergency medical services training certification.</p>
                <p><strong>Investment: $125</strong></p>
                
                <!-- Coupon Field -->
                <div style="margin-top:20px;padding:20px;border:2px solid #e3f2fd;border-radius:12px;background:linear-gradient(135deg, #f8f9ff 0%, #e8f4fd 100%)">
                    <div style="display:flex;align-items:center;margin-bottom:12px">
                        <span style="font-size:20px;margin-right:8px">🎫</span>
                        <label style="font-weight:700;color:#1976d2;font-size:16px">Have a coupon code?</label>
                    </div>
                    <div style="display:flex;gap:10px;margin-bottom:12px">
                        <input id="cp_cpr-ems" type="text" placeholder="Try: FREECPR, WIOA2025" 
                               style="flex:1;padding:12px;border:2px solid #bbdefb;border-radius:8px;font-size:16px;background:white"/>
                        <button onclick="applyCoupon('cpr-ems')" 
                                style="padding:12px 20px;background:#1976d2;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 2px 4px rgba(25,118,210,0.3)">
                            Apply
                        </button>
                    </div>
                    <div id="cpout_cpr-ems" style="font-size:15px;font-weight:500;min-height:24px;padding:8px;border-radius:6px"></div>
                </div>
                
                <button class="enroll-btn" onclick="efhEnroll({ 
                    programName:'CPR / EMS Safety Technician', 
                    amountUSD:125 
                })">Enroll Now - $125</button>
            </div>

            <div class="program-card">
                <h3>My Enrollments</h3>
                <p>Your current and completed programs:</p>
                <ul id="my-enrollments">
                    <li>Loading enrollments...</li>
                </ul>
            </div>
        </main>
    </div>

    <!-- Import Account Drawer (provides efhLoadMe, Supabase client) -->
    <script>
        // Load account drawer HTML content
        fetch('shared/account-drawer.html')
            .then(r => r.text())
            .then(html => {
                const div = document.createElement('div');
                div.innerHTML = html;
                document.body.appendChild(div);
            });
    </script>
    
    <!-- Import Enrollment Module -->
    <script type="module" src="shared/enrollment.js"></script>
    
    <!-- Enrollment JavaScript -->
    <script>
        // Show enrollments on page load
        async function showMyEnrollments() {
            const me = await window.efhLoadMe();
            if (!me?.user_id) {
                document.getElementById('my-enrollments').innerHTML = '<li>Sign in to view your enrollments</li>';
                return;
            }

            // This will be available once the account drawer loads
            if (window.efhShowEnrollments) {
                await window.efhShowEnrollments('my-enrollments');
            }
        }

        // Load enrollments after page loads
        setTimeout(showMyEnrollments, 1000);
        
        // Simple coupon validation function that works
        function applyCoupon(programSlug) {
            const code = document.getElementById(`cp_${programSlug}`).value.trim();
            const outputDiv = document.getElementById(`cpout_${programSlug}`);
            
            if (!code) {
                outputDiv.textContent = 'Please enter a coupon code';
                return;
            }
            
            outputDiv.textContent = 'Checking...';
            
            // Mock coupon validation
            const coupons = {
                'SAVE10': { type: 'percent', value: 10 },
                'WIOA2025': { type: 'percent', value: 50 },
                'FREECPR': { type: 'amount', value: 125, programs: ['cpr-ems'] },
                'NEWSTUDENT': { type: 'amount', value: 500, programs: ['business'] },
                'EARLYBIRD': { type: 'percent', value: 15 }
            };
            
            const coupon = coupons[code.toUpperCase()];
            
            if (!coupon) {
                outputDiv.innerHTML = `
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="font-size:20px">❌</span>
                        <span style="font-weight:600;color:#d32f2f">Invalid coupon code</span>
                    </div>
                `;
                outputDiv.style.background = 'linear-gradient(135deg, #ffebee 0%, #fce4ec 100%)';
                outputDiv.style.border = '2px solid #f44336';
                outputDiv.style.borderRadius = '12px';
                outputDiv.style.padding = '16px';
                return;
            }
            
            // Check program restrictions
            if (coupon.programs && !coupon.programs.includes(programSlug)) {
                outputDiv.innerHTML = `
                    <div style="display:flex;align-items:center;gap:8px">
                        <span style="font-size:20px">⚠️</span>
                        <span style="font-weight:600;color:#f57c00">Not valid for this program</span>
                    </div>
                `;
                outputDiv.style.background = 'linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%)';
                outputDiv.style.border = '2px solid #ff9800';
                outputDiv.style.borderRadius = '12px';
                outputDiv.style.padding = '16px';
                return;
            }
            
            // Calculate discount
            const prices = { 'business': 4950, 'cpr-ems': 125 };
            const originalPrice = prices[programSlug];
            let newPrice;
            
            if (coupon.type === 'percent') {
                newPrice = originalPrice * (1 - coupon.value / 100);
                const saved = originalPrice - newPrice;
                outputDiv.innerHTML = `
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                        <span style="font-size:24px">🎉</span>
                        <span style="font-size:18px;font-weight:700;color:#2e7d32">${coupon.value}% Discount Applied!</span>
                    </div>
                    <div style="background:white;padding:12px;border-radius:8px;border:1px solid #4caf50">
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                            <span>Original Price:</span>
                            <span style="text-decoration:line-through;color:#999">$${originalPrice.toFixed(2)}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                            <span style="color:#4caf50;font-weight:600">You Save:</span>
                            <span style="color:#4caf50;font-weight:700">$${saved.toFixed(2)}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;border-top:2px solid #4caf50;padding-top:8px;margin-top:8px">
                            <span style="font-size:18px;font-weight:700">New Price:</span>
                            <span style="font-size:20px;font-weight:900;color:#2e7d32">$${newPrice.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            } else {
                newPrice = Math.max(0, originalPrice - coupon.value);
                const saved = originalPrice - newPrice;
                outputDiv.innerHTML = `
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                        <span style="font-size:24px">🎉</span>
                        <span style="font-size:18px;font-weight:700;color:#2e7d32">$${coupon.value} Off Applied!</span>
                    </div>
                    <div style="background:white;padding:12px;border-radius:8px;border:1px solid #4caf50">
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                            <span>Original Price:</span>
                            <span style="text-decoration:line-through;color:#999">$${originalPrice.toFixed(2)}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                            <span style="color:#4caf50;font-weight:600">You Save:</span>
                            <span style="color:#4caf50;font-weight:700">$${saved.toFixed(2)}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;border-top:2px solid #4caf50;padding-top:8px;margin-top:8px">
                            <span style="font-size:18px;font-weight:700">New Price:</span>
                            <span style="font-size:20px;font-weight:900;color:#2e7d32">$${newPrice.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            }
            
            outputDiv.style.background = 'linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%)';
            outputDiv.style.border = '2px solid #4caf50';
            outputDiv.style.borderRadius = '12px';
            outputDiv.style.padding = '16px';
        }
    </script>

    <!-- Include the AI Chat Widget -->
    <!-- EFH AI Chat Widget (drop-in) -->
    <style>
      .efh-ai-btn {
        position: fixed;
        left: 16px;
        bottom: 16px;
        z-index: 9999;
        padding: 12px 16px;
        border: 2px solid #1976d2;
        border-radius: 999px;
        background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
        color: white;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .efh-ai-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(25, 118, 210, 0.4);
      }
      
      .efh-ai-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.3);
        backdrop-filter: blur(2px);
        opacity: 0;
        pointer-events: none;
        transition: 0.3s ease;
        z-index: 9998;
      }
      
      .efh-ai-wrap {
        position: fixed;
        bottom: 80px;
        left: 16px;
        width: min(400px, calc(100vw - 32px));
        height: 500px;
        background: white;
        border: 2px solid #e3f2fd;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        transform: scale(0.9) translateY(20px);
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s ease;
        z-index: 9999;
        display: flex;
        flex-direction: column;
      }
      
      .efh-ai-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
        color: white;
        border-radius: 14px 14px 0 0;
      }
      
      .efh-ai-title {
        font-weight: 700;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .efh-ai-close {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
        font-weight: 600;
      }
      .efh-ai-close:hover {
        background: rgba(255,255,255,0.3);
      }
      
      .efh-ai-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .efh-ai-message {
        max-width: 85%;
        padding: 12px 16px;
        border-radius: 16px;
        line-height: 1.4;
      }
      
      .efh-ai-message.user {
        align-self: flex-end;
        background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
        color: white;
        border-bottom-right-radius: 4px;
      }
      
      .efh-ai-message.assistant {
        align-self: flex-start;
        background: #f8f9fa;
        border: 1px solid #e3f2fd;
        border-bottom-left-radius: 4px;
      }
      
      .efh-ai-input-area {
        padding: 16px;
        border-top: 1px solid #e3f2fd;
        background: #fafafa;
        border-radius: 0 0 14px 14px;
      }
      
      .efh-ai-input-row {
        display: flex;
        gap: 8px;
        align-items: flex-end;
      }
      
      .efh-ai-input {
        flex: 1;
        border: 2px solid #e3f2fd;
        border-radius: 12px;
        padding: 12px;
        font-size: 14px;
        resize: none;
        min-height: 20px;
        max-height: 100px;
        background: white;
      }
      .efh-ai-input:focus {
        outline: none;
        border-color: #1976d2;
      }
      
      .efh-ai-send {
        background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 12px 16px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
      }
      .efh-ai-send:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(25, 118, 210, 0.3);
      }
      .efh-ai-send:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      
      .efh-ai-thinking {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #666;
        font-style: italic;
      }
      
      .efh-ai-thinking::after {
        content: '';
        width: 20px;
        height: 20px;
        border: 2px solid #ddd;
        border-top: 2px solid #1976d2;
        border-radius: 50%;
        animation: efh-spin 1s linear infinite;
      }
      
      @keyframes efh-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Open state */
      .efh-ai-open .efh-ai-backdrop {
        opacity: 1;
        pointer-events: auto;
      }
      
      .efh-ai-open .efh-ai-wrap {
        transform: scale(1) translateY(0);
        opacity: 1;
        pointer-events: auto;
      }
      
      @media (max-width: 480px) {
        .efh-ai-wrap {
          left: 8px;
          right: 8px;
          width: auto;
          bottom: 70px;
        }
      }
    </style>

    <button class="efh-ai-btn" id="efhAiOpen">
      <span style="font-size: 18px">🤖</span>
      Ask EFH
    </button>

    <div class="efh-ai-backdrop" id="efhAiBackdrop"></div>

    <div class="efh-ai-wrap" id="efhAiWrap" role="dialog" aria-modal="true">
      <div class="efh-ai-head">
        <div class="efh-ai-title">
          <span style="font-size: 20px">🤖</span>
          Ask EFH Assistant
        </div>
        <button class="efh-ai-close" id="efhAiClose">✕</button>
      </div>
      
      <div class="efh-ai-messages" id="efhAiMessages">
        <div class="efh-ai-message assistant">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px">
            <span style="font-size: 16px">👋</span>
            <strong>Hello!</strong>
          </div>
          I'm the Elevate for Humanity assistant. I can help you with:
          <ul style="margin: 8px 0 0 16px">
            <li>Program information and requirements</li>
            <li>Enrollment and funding questions</li>
            <li>Course schedules and logistics</li>
            <li>Career guidance and opportunities</li>
          </ul>
          What can I help you with today?
        </div>
      </div>
      
      <div class="efh-ai-input-area">
        <div class="efh-ai-input-row">
          <textarea 
            id="efhAiInput" 
            class="efh-ai-input" 
            placeholder="Ask about programs, funding, schedules..."
            rows="1"
          ></textarea>
          <button id="efhAiSend" class="efh-ai-send">Send</button>
        </div>
      </div>
    </div>

    <script>
    (function() {
      // Elements
      const btnOpen = document.getElementById('efhAiOpen');
      const backdrop = document.getElementById('efhAiBackdrop');
      const wrap = document.getElementById('efhAiWrap');
      const btnClose = document.getElementById('efhAiClose');
      const messages = document.getElementById('efhAiMessages');
      const input = document.getElementById('efhAiInput');
      const btnSend = document.getElementById('efhAiSend');
      
      let isOpen = false;
      let isThinking = false;
      
      // Chat history
      let chatHistory = [
        {
          role: "system", 
          content: "You are the helpful assistant for Elevate for Humanity, an educational training platform. Help users with program information, enrollment questions, funding guidance, and career advice. Be friendly, concise, and helpful."
        }
      ];
      
      // Toggle chat
      function toggleChat() {
        isOpen = !isOpen;
        document.body.classList.toggle('efh-ai-open', isOpen);
        
        if (isOpen) {
          input.focus();
          scrollToBottom();
        }
      }
      
      function scrollToBottom() {
        setTimeout(() => {
          messages.scrollTop = messages.scrollHeight;
        }, 100);
      }
      
      function addMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `efh-ai-message ${role}`;
        
        if (role === 'user') {
          messageDiv.textContent = content;
        } else {
          messageDiv.innerHTML = content.replace(/\n/g, '<br>');
        }
        
        messages.appendChild(messageDiv);
        scrollToBottom();
        return messageDiv;
      }
      
      function showThinking() {
        const thinkingDiv = document.createElement('div');
        thinkingDiv.className = 'efh-ai-message assistant efh-ai-thinking';
        thinkingDiv.textContent = 'EFH Assistant is thinking';
        messages.appendChild(thinkingDiv);
        scrollToBottom();
        return thinkingDiv;
      }
      
      async function sendMessage() {
        const message = input.value.trim();
        if (!message || isThinking) return;
        
        // Add user message
        addMessage('user', message);
        chatHistory.push({ role: 'user', content: message });
        
        // Clear input
        input.value = '';
        input.style.height = 'auto';
        
        // Show thinking state
        isThinking = true;
        btnSend.disabled = true;
        const thinkingDiv = showThinking();
        
        try {
          const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages: chatHistory,
              model: 'gpt-4o-mini'
            })
          });
          
          const data = await response.json();
          
          // Remove thinking indicator
          thinkingDiv.remove();
          
          if (data.error) {
            addMessage('assistant', `Sorry, I encountered an error: ${data.error}`);
          } else {
            const aiResponse = data.text || 'I apologize, but I didn\'t receive a response.';
            addMessage('assistant', aiResponse);
            chatHistory.push({ role: 'assistant', content: aiResponse });
          }
          
        } catch (error) {
          // Remove thinking indicator
          thinkingDiv.remove();
          addMessage('assistant', 'Sorry, I\'m having trouble connecting right now. Please try again in a moment.');
        }
        
        isThinking = false;
        btnSend.disabled = false;
        input.focus();
      }
      
      // Auto-resize textarea
      function autoResize() {
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 100) + 'px';
      }
      
      // Event listeners
      btnOpen.addEventListener('click', toggleChat);
      btnClose.addEventListener('click', toggleChat);
      backdrop.addEventListener('click', toggleChat);
      btnSend.addEventListener('click', sendMessage);
      
      input.addEventListener('input', autoResize);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // Make functions globally available
      window.efhAi = {
        toggle: toggleChat,
        send: sendMessage,
        addMessage,
        isOpen: () => isOpen
      };
    })();
    </script>

    <!-- Include the Account Drawer Widget -->
    <!-- EFH ACCOUNT DRAWER (drop-in) -->
    <style>
      :root { --efh-r: 14px; --efh-ink:#111; --efh-muted:#666; --efh-line:#ececec; }
      .efh-ac-btn{position:fixed;right:16px;bottom:16px;z-index:9999;padding:10px 14px;border:1px solid var(--efh-ink);border-radius:999px;background:#fff;cursor:pointer}
      .efh-ac-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.28);backdrop-filter:saturate(90%) blur(1px);opacity:0;pointer-events:none;transition:.2s ease;z-index:9998}
      .efh-ac-wrap{position:fixed;top:0;right:0;height:100%;width:min(420px, 96vw);background:#fff;border-left:1px solid var(--efh-line);box-shadow:-12px 0 40px rgba(0,0,0,.08);transform:translateX(100%);transition:transform .25s ease;z-index:9999;display:flex;flex-direction:column}
      .efh-ac-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--efh-line)}
      .efh-ac-title{font-weight:800}
      .efh-ac-close{border:1px solid var(--efh-line);background:#fff;border-radius:10px;padding:6px 9px;cursor:pointer}
      .efh-ac-body{padding:14px;overflow:auto}
      .efh-row{display:grid;gap:8px}
      .efh-row-2{grid-template-columns:1fr 1fr}
      .efh-input, .efh-select, .efh-textarea{width:100%;padding:10px;border:1px solid var(--efh-line);border-radius:12px}
      .efh-btn{padding:9px 12px;border:1px solid var(--efh-ink);border-radius:12px;background:#fff;cursor:pointer}
      .efh-muted{color:var(--efh-muted)} .efh-hint{font-size:12px;color:#777}
      .efh-card{border:1px solid var(--efh-line);border-radius:var(--efh-r);padding:12px;background:#fff;margin-bottom:12px}
      .efh-list{margin:0;padding-left:18px}
      @media (max-width: 480px){ .efh-row-2{grid-template-columns:1fr} }
      /* open state */
      .efh-ac-open .efh-ac-backdrop{opacity:1;pointer-events:auto}
      .efh-ac-open .efh-ac-wrap{transform:translateX(0)}
    </style>

    <button class="efh-ac-btn" id="efhAcOpen" aria-haspopup="dialog" aria-controls="efhAcWrap">Account</button>
    <div class="efh-ac-backdrop" id="efhAcBackdrop" hidden></div>

    <aside class="efh-ac-wrap" id="efhAcWrap" role="dialog" aria-modal="true" aria-labelledby="efhAcTitle" hidden>
      <div class="efh-ac-head">
        <div class="efh-ac-title" id="efhAcTitle">My Account</div>
        <button class="efh-ac-close" id="efhAcClose" aria-label="Close">✕</button>
      </div>
      <div class="efh-ac-body">
        <!-- Auth panel -->
        <section id="efhAuth" class="efh-card" hidden>
          <h3>Sign in</h3>
          <p class="efh-muted">Get a one-time magic link via email.</p>
          <div class="efh-row efh-row-2">
            <input id="efhEmail" class="efh-input" type="email" placeholder="you@example.com" autocomplete="email"/>
            <button id="efhSend" class="efh-btn">Send Link</button>
          </div>
          <p id="efhAuthMsg" class="efh-hint"></p>
        </section>

        <!-- Account panel -->
        <section id="efhAcct" hidden>
          <!-- Whoami -->
          <div class="efh-card">
            <div id="efhWho" class="efh-muted">Loading…</div>
          </div>

          <!-- Profile -->
          <div class="efh-card">
            <h3>Profile</h3>
            <div class="efh-row efh-row-2">
              <input id="efhFirst" class="efh-input" placeholder="First name"/>
              <input id="efhLast" class="efh-input" placeholder="Last name"/>
            </div>
            <div class="efh-row efh-row-2" style="margin-top:8px">
              <input id="efhPhone" class="efh-input" placeholder="(###) ###-####"/>
              <select id="efhLocale" class="efh-select">
                <option value="en-US">English (US)</option>
                <option value="en-GB">English (UK)</option>
                <option value="es-ES">Español</option>
              </select>
            </div>
            <textarea id="efhAddr" class="efh-textarea" rows="3" placeholder='{"street":"...","city":"...","state":"IN","zip":"..."}' style="margin-top:8px"></textarea>
            <div class="efh-row" style="margin-top:8px">
              <button id="efhSaveProfile" class="efh-btn">Save Profile</button>
              <span id="efhProfileMsg" class="efh-hint"></span>
            </div>
          </div>

          <!-- Preferences -->
          <div class="efh-card">
            <h3>Preferences</h3>
            <label><input type="checkbox" id="efhOptIn" checked/> Email updates and reminders</label>
            <textarea id="efhA11y" class="efh-textarea" rows="3" placeholder='{"fontScale":1,"highContrast":false}' style="margin-top:8px"></textarea>
            <div class="efh-row" style="margin-top:8px">
              <button id="efhSavePrefs" class="efh-btn">Save Preferences</button>
              <span id="efhPrefsMsg" class="efh-hint"></span>
            </div>
          </div>

          <!-- Funding & Vouchers -->
          <div class="efh-card">
            <h3>Funding & Vouchers</h3>
            <div class="efh-row efh-row-2">
              <input id="efhVoucherId" class="efh-input" placeholder="Voucher ID (e.g., WorkOne #)"/>
              <input id="efhCaseMgr" class="efh-input" placeholder="Case Manager Email"/>
            </div>
            <div class="efh-row efh-row-2" style="margin-top:8px">
              <select id="efhFundingSrc" class="efh-select">
                <option value="">Funding Source (optional)</option>
                <option value="WIOA">WIOA / WorkOne</option>
                <option value="ETPL">INTraining / ETPL</option>
                <option value="WRG">Workforce Ready Grant</option>
                <option value="Self-Pay">Self-Pay</option>
                <option value="Other">Other</option>
              </select>
              <input id="efhCoupon" class="efh-input" placeholder="Coupon / Promo Code (optional)"/>
            </div>
            <div class="efh-row" style="margin-top:8px">
              <button id="efhSaveFunding" class="efh-btn">Save Funding Info</button>
              <span id="efhFundingMsg" class="efh-hint"></span>
            </div>
            <p class="efh-hint">We'll attach these details to your checkout for faster authorization and billing support.</p>
          </div>

          <!-- Enrollments -->
          <div class="efh-card">
            <h3>My Enrollments</h3>
            <ul id="efhEnrollList" class="efh-list efh-muted"><li>Loading…</li></ul>
          </div>

          <div class="efh-row" style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <button id="efhSignOut" class="efh-btn">Sign out</button>
          </div>
        </section>
      </div>
    </aside>

    <script type="module">
      import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

      // TODO: replace with your values
      const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co';
      const SUPABASE_ANON_KEY = 'YOUR_PUBLIC_ANON_KEY';

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, storage: localStorage } });

      // Elements
      const root = document.documentElement;
      const btnOpen = document.getElementById('efhAcOpen');
      const backdrop = document.getElementById('efhAcBackdrop');
      const wrap = document.getElementById('efhAcWrap');
      const btnClose = document.getElementById('efhAcClose');

      const authSec = document.getElementById('efhAuth');
      const acctSec = document.getElementById('efhAcct');
      const emailEl = document.getElementById('efhEmail');
      const sendBtn = document.getElementById('efhSend');
      const authMsg = document.getElementById('efhAuthMsg');

      const who = document.getElementById('efhWho');
      const first = document.getElementById('efhFirst');
      const last = document.getElementById('efhLast');
      const phone = document.getElementById('efhPhone');
      const locale = document.getElementById('efhLocale');
      const addr = document.getElementById('efhAddr');
      const saveProf = document.getElementById('efhSaveProfile');
      const profMsg = document.getElementById('efhProfileMsg');

      const optIn = document.getElementById('efhOptIn');
      const a11y = document.getElementById('efhA11y');
      const savePrefs = document.getElementById('efhSavePrefs');
      const prefsMsg = document.getElementById('efhPrefsMsg');

      const enrollList = document.getElementById('efhEnrollList');
      const signOut = document.getElementById('efhSignOut');

      // Funding elements
      const voucherId = document.getElementById('efhVoucherId');
      const caseMgr   = document.getElementById('efhCaseMgr');
      const fundingSrc= document.getElementById('efhFundingSrc');
      const coupon    = document.getElementById('efhCoupon');
      const saveFunding = document.getElementById('efhSaveFunding');
      const fundingMsg  = document.getElementById('efhFundingMsg');

      // === Funding state (persisted locally and used at checkout) ===
      const efhFunding = {
        get() {
          try { return JSON.parse(localStorage.getItem('EFH_FUNDING') || '{}'); }
          catch { return {}; }
        },
        set(obj) {
          localStorage.setItem('EFH_FUNDING', JSON.stringify(obj || {}));
        },
        merge(partial) {
          const cur = this.get();
          const next = { ...cur, ...partial };
          this.set(next);
          return next;
        }
      };

      // Load saved funding into fields
      function loadFundingIntoForm() {
        const f = efhFunding.get();
        voucherId.value = f.voucher_id || '';
        caseMgr.value   = f.case_manager_email || '';
        fundingSrc.value= f.funding_source || '';
        coupon.value    = f.coupon || '';
      }

      // Open/close drawer
      function openDrawer() {
        loadFundingIntoForm();
        root.classList.add('efh-ac-open');
        backdrop.hidden = false; wrap.hidden = false;
        setTimeout(()=> emailEl?.focus(), 50);
      }
      function closeDrawer() {
        root.classList.remove('efh-ac-open');
        backdrop.hidden = true; wrap.hidden = true;
      }
      btnOpen.addEventListener('click', openDrawer);
      btnClose.addEventListener('click', closeDrawer);
      backdrop.addEventListener('click', closeDrawer);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDrawer(); });

      // Helpers
      async function ensureAppUser(user) {
        await supabase.from('app_users').upsert({ auth_user_id: user.id, email: user.email }, { onConflict: 'auth_user_id' });
        const row = await supabase.from('app_users').select('id').eq('auth_user_id', user.id).single();
        return row.data?.id || null;
      }
      async function loadProfile(user_id) {
        const { data: prof } = await supabase.from('profiles').select('*').eq('user_id', user_id).maybeSingle();
        const { data: prefs } = await supabase.from('preferences').select('*').eq('user_id', user_id).maybeSingle();
        if (prof) { first.value = prof.first_name||''; last.value = prof.last_name||''; phone.value = prof.phone||''; addr.value = prof.address ? JSON.stringify(prof.address) : ''; }
        if (prefs) { 
          optIn.checked = prefs.email_opt_in ?? true; 
          locale.value = prefs.locale||'en-US'; 
          a11y.value = prefs.accessibility ? JSON.stringify(prefs.accessibility) : '';
          
          // Load funding data from Supabase if available
          if (prefs.accessibility?.funding) {
            efhFunding.set(prefs.accessibility.funding);
            loadFundingIntoForm();
          }
        }
      }
      async function loadEnrollments() {
        const { data, error } = await supabase.from('enrollments').select('program_slug,status,started_at,completed_at').order('created_at', { ascending:false });
        if (error) { enrollList.innerHTML = `<li>${error.message}</li>`; return; }
        if (!data?.length) { enrollList.innerHTML = `<li class="efh-muted">No enrollments yet.</li>`; return; }
        enrollList.innerHTML = data.map(e=>{
          const started = e.started_at ? new Date(e.started_at).toLocaleDateString() : '—';
          const done = e.completed_at ? `, completed ${new Date(e.completed_at).toLocaleDateString()}` : '';
          return `<li><strong>${e.program_slug}</strong> — ${e.status} (started ${started}${done})</li>`;
        }).join('');

        // Also update the main page enrollment list
        const mainList = document.getElementById('my-enrollments');
        if (mainList) {
          if (!data?.length) {
            mainList.innerHTML = '<li>No enrollments yet. Sign in and enroll in a program!</li>';
          } else {
            mainList.innerHTML = data.map(e => `<li><strong>${e.program_slug}</strong> — ${e.status}</li>`).join('');
          }
        }
      }

      // Auth flow
      async function refreshUI() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) {
          authSec.hidden = false; acctSec.hidden = true; who.textContent = 'Not signed in.'; 
          document.getElementById('my-enrollments').innerHTML = '<li>Sign in to view your enrollments</li>';
          return;
        }
        authSec.hidden = true; acctSec.hidden = false;
        who.textContent = `Signed in as ${user.email}`;
        const user_id = await ensureAppUser(user);
        await loadProfile(user_id);
        await loadEnrollments();
      }

      // Global function for other scripts
      window.efhLoadMe = async function() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return null;
        const user_id = await ensureAppUser(user);
        return { user, user_id };
      };

      sendBtn.addEventListener('click', async ()=>{
        const email = emailEl.value.trim();
        if (!email) { authMsg.textContent = 'Enter your email.'; return; }
        sendBtn.disabled = true; authMsg.textContent = 'Sending…';
        const { error } = await supabase.auth.signInWithOtp({ email });
        sendBtn.disabled = false;
        authMsg.textContent = error ? error.message : 'Check your email for the sign-in link.';
      });

      saveProf.addEventListener('click', async ()=>{
        profMsg.textContent = 'Saving…';
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        const { data: u } = await supabase.from('app_users').select('id').eq('auth_user_id', user.id).single();
        let address = null;
        if (addr.value.trim()) { try { address = JSON.parse(addr.value); } catch { profMsg.textContent = 'Address must be JSON'; return; } }
        const { error } = await supabase.from('profiles').upsert({
          user_id: u.id, first_name:first.value.trim(), last_name:last.value.trim(),
          phone:phone.value.trim(), address, updated_at: new Date().toISOString()
        });
        profMsg.textContent = error ? error.message : 'Saved.';
      });

      savePrefs.addEventListener('click', async ()=>{
        prefsMsg.textContent = 'Saving…';
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        const { data: u } = await supabase.from('app_users').select('id').eq('auth_user_id', user.id).single();
        let accessibility = null;
        if (a11y.value.trim()) { try { accessibility = JSON.parse(a11y.value); } catch { prefsMsg.textContent = 'Accessibility must be JSON'; return; } }
        const { error } = await supabase.from('preferences').upsert({
          user_id: u.id, email_opt_in: !!optIn.checked, locale: locale.value, accessibility, updated_at: new Date().toISOString()
        });
        prefsMsg.textContent = error ? error.message : 'Saved.';
      });

      signOut.addEventListener('click', async ()=>{ await supabase.auth.signOut(); await refreshUI(); });

      // Save funding button
      saveFunding?.addEventListener('click', async ()=>{
        // Basic validation
        const email = caseMgr.value.trim();
        if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          fundingMsg.textContent = 'Case Manager Email looks invalid.';
          return;
        }
        
        // Save locally
        efhFunding.merge({
          voucher_id: voucherId.value.trim(),
          case_manager_email: email || '',
          funding_source: fundingSrc.value,
          coupon: coupon.value.trim()
        });
        
        // Also save to Supabase if signed in
        try {
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) { 
            fundingMsg.textContent = 'Saved locally. Sign in to sync to your account.'; 
            return; 
          }
          const { data: u } = await supabase.from('app_users').select('id').eq('auth_user_id', user.id).single();
          const user_id = u?.id;
          const { data: prefsRow } = await supabase.from('preferences').select('accessibility, locale, email_opt_in').eq('user_id', user_id).maybeSingle();
          const f = efhFunding.get();
          const a11y = prefsRow?.accessibility || {};
          // Store under accessibility.funding
          const newA11y = { ...a11y, funding: f };
          await supabase.from('preferences').upsert({
            user_id,
            email_opt_in: prefsRow?.email_opt_in ?? true,
            locale: prefsRow?.locale || 'en-US',
            accessibility: newA11y,
            updated_at: new Date().toISOString()
          });
          fundingMsg.textContent = 'Saved & synced.';
        } catch (e) {
          fundingMsg.textContent = 'Saved locally (sync failed).';
        }
      });

      // === Merge funding info into ALL efhEnroll calls ===
      (function wrapEnroll(){
        const PAY_API = window.PAY_API || "https://pay.elevateforhumanity.org/api/checkout";

        // Override the global efhEnroll function to include funding metadata
        window.efhEnroll = async function({ programName, priceId="", amountUSD=0, metadata={} }) {
          // Attach funding info
          const f = efhFunding.get();
          const fundingMeta = {};
          if (f.voucher_id)          fundingMeta.voucher_id = f.voucher_id;
          if (f.case_manager_email)  fundingMeta.case_manager_email = f.case_manager_email;
          if (f.funding_source)      fundingMeta.funding_source = f.funding_source;
          if (f.coupon)              fundingMeta.coupon = f.coupon;

          const mergedMeta = { ...metadata, ...fundingMeta };

          const body = priceId
            ? { priceId, quantity: 1, metadata: mergedMeta }
            : { productName: programName, unitAmount: Math.round(amountUSD * 100), currency: "usd", quantity: 1, metadata: mergedMeta };

          const res = await fetch(PAY_API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(body)
          });
          const data = await res.json();
          if (data?.url) window.location.href = data.url;
          else alert(data?.error || "Checkout failed");
        };
      })();

      // Initialize
      await refreshUI();
    </script>
    <!-- /EFH ACCOUNT DRAWER -->

    <!-- Load Shared Components -->
    <script>
        // Load shared navigation and account drawer  
        Promise.all([
            fetch('shared/navigation.html').then(r => r.text()),
            fetch('shared/account-drawer.html').then(r => r.text())
        ]).then(([navHtml, drawerHtml]) => {
            document.getElementById('shared-nav').innerHTML = navHtml;
            document.body.insertAdjacentHTML('beforeend', drawerHtml);
        });
    </script>

    <!-- EFH Universal Footer -->
    <div id="efh-footer"></div>

    <!-- Load Header/Footer -->
    <script>
    (async () => {
        try {
            const [headerRes, footerRes] = await Promise.all([
                fetch('/ui/header.html'),
                fetch('/ui/footer.html')
            ]);
            
            if (headerRes.ok) {
                const headerHTML = await headerRes.text();
                document.getElementById('efh-header').innerHTML = headerHTML;
            }
            
            if (footerRes.ok) {
                const footerHTML = await footerRes.text();
                document.getElementById('efh-footer').innerHTML = footerHTML;
            }
        } catch (error) {
            console.log('Header/footer loading failed:', error);
        }
    })();
    </script>

</body>
</html>