<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Serverless Architecture Test | Elevate for Humanity</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem; }
        .test-section { margin: 2rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; }
        .test-button { background: #3b82f6; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; margin: 0.5rem; }
        .test-result { margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .loading { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>🚀 Serverless Architecture Test Dashboard</h1>
    <p>Test the new serverless functions and architecture components.</p>

    <div class="test-section">
        <h2>📄 On-Demand Builder Test</h2>
        <p>Test the page generation system for 150k+ pages.</p>
        <button class="test-button" onclick="testPageODB()">Test Page Generation</button>
        <div id="odb-result" class="test-result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>☁️ R2 Proxy Test</h2>
        <p>Test Cloudflare R2 asset delivery through Netlify.</p>
        <button class="test-button" onclick="testR2Proxy()">Test R2 Assets</button>
        <div id="r2-result" class="test-result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>🗺️ Sitemap Generation Test</h2>
        <p>Test the automated sitemap generation system.</p>
        <button class="test-button" onclick="testSitemapGeneration()">Generate Sitemaps</button>
        <div id="sitemap-result" class="test-result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>🔐 Authentication Test</h2>
        <p>Test Supabase authentication integration.</p>
        <button id="loginBtn" class="test-button">Sign In with Google</button>
        <button id="logoutBtn" class="test-button" style="display: none;">Sign Out</button>
        <div id="userInfo" style="display: none; margin-top: 1rem;"></div>
        <button class="test-button" onclick="testSecureAPI()" style="display: none;" id="apiTestBtn">Test Secure API</button>
        <div id="auth-result" class="test-result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>📊 Architecture Status</h2>
        <div id="architecture-status">
            <p>✅ Netlify Functions: Ready</p>
            <p>✅ On-Demand Builders: Configured</p>
            <p>✅ R2 Proxy: Configured</p>
            <p>✅ Scheduled Functions: Configured</p>
            <p>⚠️ Supabase: Needs environment variables</p>
            <p>⚠️ R2 Storage: Needs environment variables</p>
        </div>
    </div>

    <script src="/auth-integration.js"></script>
    <script>
        // Test functions
        async function testPageODB() {
            const result = document.getElementById('odb-result')
            result.style.display = 'block'
            result.className = 'test-result loading'
            result.innerHTML = '🔄 Testing page generation...'

            try {
                const response = await fetch('/page/test-dynamic-page')
                const html = await response.text()
                
                if (response.ok && html.includes('Elevate for Humanity')) {
                    result.className = 'test-result success'
                    result.innerHTML = `✅ Page generation successful!<br>Status: ${response.status}<br>Content length: ${html.length} characters`
                } else {
                    result.className = 'test-result error'
                    result.innerHTML = `❌ Page generation failed<br>Status: ${response.status}`
                }
            } catch (error) {
                result.className = 'test-result error'
                result.innerHTML = `❌ Error: ${error.message}`
            }
        }

        async function testR2Proxy() {
            const result = document.getElementById('r2-result')
            result.style.display = 'block'
            result.className = 'test-result loading'
            result.innerHTML = '🔄 Testing R2 proxy...'

            try {
                const response = await fetch('/r2-assets/test-file.txt')
                
                if (response.ok) {
                    const content = await response.text()
                    result.className = 'test-result success'
                    result.innerHTML = `✅ R2 proxy working!<br>Status: ${response.status}<br>Content: ${content.substring(0, 100)}...`
                } else if (response.status === 404) {
                    result.className = 'test-result success'
                    result.innerHTML = `✅ R2 proxy configured correctly<br>Status: 404 (expected for missing file)`
                } else {
                    result.className = 'test-result error'
                    result.innerHTML = `❌ R2 proxy error<br>Status: ${response.status}`
                }
            } catch (error) {
                result.className = 'test-result error'
                result.innerHTML = `❌ Error: ${error.message}`
            }
        }

        async function testSitemapGeneration() {
            const result = document.getElementById('sitemap-result')
            result.style.display = 'block'
            result.className = 'test-result loading'
            result.innerHTML = '🔄 Generating sitemaps...'

            try {
                const response = await fetch('/.netlify/functions/sitemap-cron', {
                    method: 'POST'
                })
                const data = await response.json()
                
                if (response.ok && data.success) {
                    result.className = 'test-result success'
                    result.innerHTML = `✅ Sitemap generation successful!<br>Sitemaps: ${data.sitemaps}<br>Total URLs: ${data.totalUrls}`
                } else {
                    result.className = 'test-result error'
                    result.innerHTML = `❌ Sitemap generation failed<br>Error: ${data.error || 'Unknown error'}`
                }
            } catch (error) {
                result.className = 'test-result error'
                result.innerHTML = `❌ Error: ${error.message}`
            }
        }

        async function testSecureAPI() {
            const result = document.getElementById('auth-result')
            result.style.display = 'block'
            result.className = 'test-result loading'
            result.innerHTML = '🔄 Testing secure API...'

            try {
                const profile = await window.auth.callSecureAPI('/profile')
                result.className = 'test-result success'
                result.innerHTML = `✅ Secure API working!<br>User: ${profile.user.email}<br>ID: ${profile.user.id}`
            } catch (error) {
                result.className = 'test-result error'
                result.innerHTML = `❌ Secure API error: ${error.message}`
            }
        }

        // Update UI when auth state changes
        if (window.auth) {
            window.auth.updateUI = function() {
                const loginBtn = document.getElementById('loginBtn')
                const logoutBtn = document.getElementById('logoutBtn')
                const userInfo = document.getElementById('userInfo')
                const apiTestBtn = document.getElementById('apiTestBtn')

                if (this.user) {
                    loginBtn.style.display = 'none'
                    logoutBtn.style.display = 'inline-block'
                    apiTestBtn.style.display = 'inline-block'
                    userInfo.style.display = 'block'
                    userInfo.innerHTML = `👤 Signed in as: ${this.user.email}`
                } else {
                    loginBtn.style.display = 'inline-block'
                    logoutBtn.style.display = 'none'
                    apiTestBtn.style.display = 'none'
                    userInfo.style.display = 'none'
                }
            }
        }
    </script>
</body>
</html>