<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self' https:; frame-ancestors 'none';">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Individual Employment Plans (IEP) - DOL/DWD Compliance</title>
    <meta name="description" content="Create and manage Individual Employment Plans for federal workforce development compliance">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="scripts/efh-universal.v2.2.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation Header -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        
                        <div class="text-sm text-gray-500">${iep.user_id}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${iep.program_slug}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${iep.employment_goal || 'Not specified'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(iep.status)}">
                            ${iep.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(iep.created_at).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewIEP('${iep.id}')" class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                        <button onclick="editIEP('${iep.id}')" class="text-green-600 hover:text-green-900 mr-3">Edit</button>
                        ${iep.status === 'draft' ? `<button onclick="approveIEP('${iep.id}')" class="text-purple-600 hover:text-purple-900">Approve</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusColor(status) {
            switch(status) {
                case 'draft': return 'bg-gray-100 text-gray-800';
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'approved': return 'bg-green-100 text-green-800';
                case 'active': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function showCreateIEPForm() {
            document.getElementById('create-iep-modal').classList.remove('hidden');
        }

        function hideCreateIEPForm() {
            document.getElementById('create-iep-modal').classList.add('hidden');
            document.getElementById('iep-form').reset();
        }

        async function createIEP(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            // Collect barriers and services
            const barriers = Array.from(formData.getAll('barriers'));
            const services = Array.from(formData.getAll('services'));
            
            const iepData = {
                user_id: 'system', // In real implementation, get from authenticated user
                participant_name: formData.get('participant_name'),
                program_slug: formData.get('program_slug'),
                employment_goal: formData.get('employment_goal'),
                barrier_assessment: {
                    barriers: barriers,
                    details: formData.get('barrier_details')
                },
                services_needed: services,
                timeline: {
                    start_date: formData.get('start_date'),
                    target_completion: formData.get('target_completion'),
                    milestones: formData.get('milestones')
                }
            };

            try {
                const response = await fetch('/api/compliance/iep', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(iepData)
                });

                if (response.ok) {
                    hideCreateIEPForm();
                    loadIEPs();
                    alert('IEP created successfully!');
                } else {
                    alert('Error creating IEP. Please try again.');
                }
            } catch (error) {
                console.error('Error creating IEP:', error);
                alert('Error creating IEP. Please try again.');
            }
        }

        async function approveIEP(iepId) {
            if (!confirm('Are you sure you want to approve this IEP?')) return;

            try {
                const response = await fetch(`/api/compliance/iep/${iepId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: 'approved',
                        approved_by: 'current_user' // In real implementation, get from auth
                    })
                });

                if (response.ok) {
                    loadIEPs();
                    alert('IEP approved successfully!');
                } else {
                    alert('Error approving IEP. Please try again.');
                }
            } catch (error) {
                console.error('Error approving IEP:', error);
                alert('Error approving IEP. Please try again.');
            }
        }

        function viewIEP(iepId) {
            // In real implementation, show detailed view modal
            alert(`Viewing IEP: ${iepId}`);
        }

        function editIEP(iepId) {
            // In real implementation, open edit form
            alert(`Editing IEP: ${iepId}`);
        }

        function filterIEPs() {
            const status = document.getElementById('status-filter').value;
            // Filter and reload IEPs based on status
            loadIEPs();
        }

        function searchIEPs() {
            const searchTerm = document.getElementById('search-ieps').value;
            // Search and filter IEPs
            loadIEPs();
        }

        function exportIEPs() {
            // Export IEPs to CSV or PDF
            alert('Exporting IEPs...');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadIEPs();
        });
    </script>
</body>
</html>