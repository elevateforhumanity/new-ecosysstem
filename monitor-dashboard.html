
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self' https:; frame-ancestors 'none';">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EFH System Monitor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-online { background-color: #10b981; }
        .status-warning { background-color: #f59e0b; }
        .status-error { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    
            </div>
            
            <button onclick="saveNotificationSettings()" 
                    class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                Save Settings
            </button>
        </div>
    </div>
    
    <script>
        let pageViewsChart, paymentsChart;
        
        // Initialize charts
        function initCharts() {
            // Page Views Chart
            const pageViewsCtx = document.getElementById('pageViewsChart').getContext('2d');
            pageViewsChart = new Chart(pageViewsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Page Views',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            // Payments Chart
            const paymentsCtx = document.getElementById('paymentsChart').getContext('2d');
            paymentsChart = new Chart(paymentsCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Successful', 'Failed', 'Pending'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b']
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
        
        // Fetch and update metrics
        async function updateMetrics() {
            try {
                const response = await fetch('/api/monitor/metrics');
                const data = await response.json();
                
                // Update system status
                document.getElementById('active-users').textContent = data.summary.activeUsers || '0';
                document.getElementById('memory-usage').textContent = data.systemHealth.memory + 'MB';
                document.getElementById('uptime').textContent = Math.round(data.systemHealth.uptime / 1000 / 60 / 60) + 'h';
                
                // Update summary
                document.getElementById('total-views').textContent = data.summary.totalPageViews || '0';
                document.getElementById('total-enrollments').textContent = data.summary.totalEnrollments || '0';
                document.getElementById('total-errors').textContent = data.summary.totalErrors || '0';
                
                // Update last update time
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                
                // Update charts
                updateCharts(data);
                
            } catch (error) {
                console.error('Failed to update metrics:', error);
                updateSystemStatus('error');
            }
        }
        
        // Update charts with new data
        function updateCharts(data) {
            // Update page views chart with hourly data
            const hourlyViews = getHourlyPageViews(data.pageViews);
            pageViewsChart.data.labels = hourlyViews.labels;
            pageViewsChart.data.datasets[0].data = hourlyViews.data;
            pageViewsChart.update();
            
            // Update payments chart
            const paymentStats = getPaymentStats(data.payments);
            paymentsChart.data.datasets[0].data = [
                paymentStats.successful,
                paymentStats.failed,
                paymentStats.pending
            ];
            paymentsChart.update();
            
            // Update payment summary
            document.getElementById('successful-payments').textContent = paymentStats.successful;
            document.getElementById('failed-payments').textContent = paymentStats.failed;
            document.getElementById('total-revenue').textContent = '$' + paymentStats.totalRevenue;
        }
        
        // Get hourly page views for chart
        function getHourlyPageViews(pageViews) {
            const hours = [];
            const data = [];
            const now = new Date();
            
            for (let i = 23; i >= 0; i--) {
                const hour = new Date(now.getTime() - i * 60 * 60 * 1000);
                hours.push(hour.getHours() + ':00');
                
                // Count views in this hour
                let hourlyCount = 0;
                Object.values(pageViews).forEach(views => {
                    views.forEach(view => {
                        const viewTime = new Date(view.timestamp);
                        if (viewTime.getHours() === hour.getHours() && 
                            viewTime.toDateString() === hour.toDateString()) {
                            hourlyCount++;
                        }
                    });
                });
                data.push(hourlyCount);
            }
            
            return { labels: hours, data: data };
        }
        
        // Get payment statistics
        function getPaymentStats(payments) {
            let successful = 0, failed = 0, pending = 0, totalRevenue = 0;
            
            Object.entries(payments).forEach(([status, paymentList]) => {
                if (status === 'succeeded') {
                    successful = paymentList.length;
                    totalRevenue = paymentList.reduce((sum, p) => sum + (p.amount || 0), 0);
                } else if (status === 'failed') {
                    failed = paymentList.length;
                } else if (status === 'pending') {
                    pending = paymentList.length;
                }
            });
            
            return { successful, failed, pending, totalRevenue };
        }
        
        // Update system status indicator
        function updateSystemStatus(status) {
            const statusEl = document.getElementById('system-status');
            const dotEl = document.getElementById('status-dot');
            
            switch (status) {
                case 'online':
                    statusEl.textContent = 'Online';
                    statusEl.className = 'text-2xl font-bold text-green-600';
                    dotEl.className = 'status-dot status-online';
                    break;
                case 'warning':
                    statusEl.textContent = 'Warning';
                    statusEl.className = 'text-2xl font-bold text-yellow-600';
                    dotEl.className = 'status-dot status-warning';
                    break;
                case 'error':
                    statusEl.textContent = 'Error';
                    statusEl.className = 'text-2xl font-bold text-red-600';
                    dotEl.className = 'status-dot status-error';
                    break;
            }
        }
        
        // Add activity to live feed
        function addActivityItem(type, message, timestamp) {
            const feed = document.getElementById('activity-feed');
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';
            
            const icon = type === 'enrollment' ? 'üéì' : 
                        type === 'payment' ? 'üí≥' : 
                        type === 'view' ? 'üëÅÔ∏è' : 'üìä';
            
            item.innerHTML = `
                <div class="flex items-center">
                    <span class="mr-2">${icon}</span>
                    <span class="text-sm">${message}</span>
                </div>
                <span class="text-xs text-gray-500">${new Date(timestamp).toLocaleTimeString()}</span>
            `;
            
            feed.insertBefore(item, feed.firstChild);
            
            // Keep only last 20 items
            while (feed.children.length > 20) {
                feed.removeChild(feed.lastChild);
            }
        }
        
        // Save notification settings
        function saveNotificationSettings() {
            const email = document.getElementById('admin-email').value;
            const frequency = document.getElementById('notification-frequency').value;
            
            // Save to localStorage for now (in production, save to database)
            localStorage.setItem('monitorSettings', JSON.stringify({
                adminEmail: email,
                frequency: frequency,
                lastSaved: new Date().toISOString()
            }));
            
            alert('Notification settings saved!');
        }
        
        // Load saved settings
        function loadSettings() {
            const saved = localStorage.getItem('monitorSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('admin-email').value = settings.adminEmail || '';
                document.getElementById('notification-frequency').value = settings.frequency || 'daily';
            }
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadSettings();
            updateMetrics();
            updateSystemStatus('online');
            
            // Update metrics every 30 seconds
            setInterval(updateMetrics, 30000);
            
            // Simulate some live activity for demo
            setTimeout(() => {
                addActivityItem('view', 'New visitor on Programs page', new Date());
            }, 2000);
            
            setTimeout(() => {
                addActivityItem('enrollment', 'User enrolled in Data Science course', new Date());
            }, 5000);
        });
    </script>
</body>
</html>
