<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self' https:; frame-ancestors 'none';">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIRL Reporting - DOL/DWD Federal Compliance</title>
    <meta name="description" content="Participant Individual Record Layout (PIRL) reporting for federal workforce development compliance">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="scripts/efh-universal.v2.2.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    
                                
                        <div class="text-sm text-gray-500">${report.user_id}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${report.reporting_period}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900">
                        ${report.federal_id || 'Pending'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${getPIRLStatusColor(report.report_status)}">
                            ${report.report_status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${report.submitted_at ? new Date(report.submitted_at).toLocaleDateString() : 'Not submitted'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewPIRL('${report.id}')" class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                        ${report.report_status === 'draft' ? `<button onclick="submitPIRL('${report.id}')" class="text-green-600 hover:text-green-900">Submit</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getPIRLStatusColor(status) {
            switch(status) {
                case 'draft': return 'bg-gray-100 text-gray-800';
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'submitted': return 'bg-blue-100 text-blue-800';
                case 'approved': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function showGeneratePIRLForm() {
            document.getElementById('generate-pirl-modal').classList.remove('hidden');
            loadParticipants();
        }

        function hideGeneratePIRLForm() {
            document.getElementById('generate-pirl-modal').classList.add('hidden');
            document.getElementById('pirl-form').reset();
        }

        async function loadParticipants() {
            try {
                const response = await fetch('/api/compliance/eligibility?status=verified');
                const data = await response.json();
                const select = document.querySelector('select[name="user_id"]');
                
                select.innerHTML = '<option value="">Select Participant</option>';
                data.verifications?.forEach(verification => {
                    select.innerHTML += `<option value="${verification.user_id}">${verification.email}</option>`;
                });
            } catch (error) {
                console.error('Error loading participants:', error);
            }
        }

        async function generatePIRL(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const demographics = Array.from(formData.getAll('demographics'));
            
            const pirlData = {
                user_id: formData.get('user_id'),
                reporting_period: formData.get('reporting_period'),
                participant_data: {
                    ssn: formData.get('ssn'),
                    date_of_birth: formData.get('date_of_birth'),
                    gender: formData.get('gender'),
                    race_ethnicity: formData.get('race_ethnicity')
                },
                employment_data: {
                    employment_status_entry: formData.get('employment_status_entry'),
                    employment_status_exit: formData.get('employment_status_exit'),
                    wages_entry: parseFloat(formData.get('wages_entry')) || 0,
                    wages_exit: parseFloat(formData.get('wages_exit')) || 0
                },
                education_data: {
                    education_level: formData.get('education_level'),
                    school_status: formData.get('school_status')
                },
                demographic_data: {
                    demographics: demographics
                }
            };

            try {
                const response = await fetch('/api/compliance/pirl', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(pirlData)
                });

                if (response.ok) {
                    hideGeneratePIRLForm();
                    loadPIRLReports();
                    alert('PIRL report generated successfully!');
                } else {
                    alert('Error generating PIRL report. Please try again.');
                }
            } catch (error) {
                console.error('Error generating PIRL:', error);
                alert('Error generating PIRL report. Please try again.');
            }
        }

        async function submitPIRL(pirlId) {
            if (!confirm('Are you sure you want to submit this PIRL report to DOL/DWD?')) return;

            try {
                const response = await fetch(`/api/compliance/pirl/${pirlId}/submit`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        submitted_by: 'current_user' // In real implementation, get from auth
                    })
                });

                if (response.ok) {
                    loadPIRLReports();
                    alert('PIRL report submitted successfully to federal systems!');
                } else {
                    alert('Error submitting PIRL report. Please try again.');
                }
            } catch (error) {
                console.error('Error submitting PIRL:', error);
                alert('Error submitting PIRL report. Please try again.');
            }
        }

        function viewPIRL(pirlId) {
            // In real implementation, show detailed view modal
            alert(`Viewing PIRL Report: ${pirlId}`);
        }

        function showBulkSubmission() {
            alert('Bulk submission feature coming soon...');
        }

        function showReportHistory() {
            alert('Report history view coming soon...');
        }

        function filterReports() {
            // Filter reports based on period and status
            loadPIRLReports();
        }

        function searchReports() {
            // Search functionality
            loadPIRLReports();
        }

        function exportReports() {
            // Export to CSV/PDF
            alert('Exporting PIRL reports...');
        }

        function loadParticipantData() {
            // Auto-populate participant data when selected
            const userId = document.querySelector('select[name="user_id"]').value;
            if (userId) {
                // In real implementation, load existing participant data
                console.log('Loading data for participant:', userId);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadPIRLReports();
        });
    </script>
</body>
</html>