<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Signing you in... â€“ Elevate for Humanity</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <main class="section" id="main">
    <div style="max-width: 400px; margin: 4rem auto; text-align: center;">
      <h1>Signing you in...</h1>
      <p id="status">Please wait while we complete your sign-in.</p>
      <div style="margin: 2rem 0;">
        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--brand); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
      </div>
    </div>
  </main>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    
    const supabaseUrl = import.meta.env?.VITE_SUPABASE_URL || 'YOUR_SUPABASE_URL';
    const supabaseAnonKey = import.meta.env?.VITE_SUPABASE_ANON_KEY || 'YOUR_SUPABASE_ANON_KEY';
    
    if (supabaseUrl === 'YOUR_SUPABASE_URL' || supabaseAnonKey === 'YOUR_SUPABASE_ANON_KEY') {
      document.getElementById('status').textContent = 'Authentication service not configured.';
    } else {
      const supabase = createClient(supabaseUrl, supabaseAnonKey);
      
      // Get redirect URL from query parameters
      const params = new URLSearchParams(location.search);
      const redirectTo = params.get('redirect') || '/portal/';
      
      // Handle the OAuth callback
      supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN' && session) {
          // Optional: Set access token as cookie for edge function compatibility
          const accessToken = session.access_token;
          if (accessToken) {
            // Set cookie with 7-day expiration
            const expires = new Date();
            expires.setDate(expires.getDate() + 7);
            document.cookie = `sb-access-token=${encodeURIComponent(accessToken)}; expires=${expires.toUTCString()}; path=/; secure; samesite=strict`;
          }
          
          // Redirect to the intended destination
          document.getElementById('status').textContent = 'Sign-in successful! Redirecting...';
          setTimeout(() => {
            window.location.href = redirectTo;
          }, 1000);
        } else if (event === 'SIGNED_OUT') {
          document.getElementById('status').textContent = 'Sign-in failed. Redirecting to login...';
          setTimeout(() => {
            window.location.href = '/login.html';
          }, 2000);
        }
      });
      
      // Handle the initial session from URL hash
      supabase.auth.getSession().then(({ data: { session }, error }) => {
        if (error) {
          document.getElementById('status').textContent = `Error: ${error.message}`;
          setTimeout(() => {
            window.location.href = '/login.html';
          }, 3000);
        } else if (session) {
          // Session already exists, redirect
          document.getElementById('status').textContent = 'Already signed in! Redirecting...';
          setTimeout(() => {
            window.location.href = redirectTo;
          }, 1000);
        } else {
          // Wait for auth state change
          setTimeout(() => {
            // If no auth state change after 5 seconds, redirect to login
            document.getElementById('status').textContent = 'Sign-in timeout. Redirecting to login...';
            window.location.href = '/login.html';
          }, 5000);
        }
      });
    }
  </script>
</body>
</html>