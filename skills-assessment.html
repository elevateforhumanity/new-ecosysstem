<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self' https:; frame-ancestors 'none';">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains; preload">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skills Assessment - DOL/DWD Compliance</title>
    <meta name="description" content="Participant skills assessment and tracking system for federal workforce development compliance">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="scripts/efh-universal.v2.2.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation Header -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        
                        <div class="text-sm text-gray-500">${assessment.user_id}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${formatAssessmentType(assessment.assessment_type)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${assessment.program_slug}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${skillCount} areas assessed</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="text-sm font-medium text-gray-900">${avgScore}%</div>
                            <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                                <div class="bg-${getScoreColor(avgScore)}-600 h-2 rounded-full" style="width: ${avgScore}%"></div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${assessment.assessment_date ? new Date(assessment.assessment_date).toLocaleDateString() : 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewAssessment('${assessment.id}')" class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                        <button onclick="editAssessment('${assessment.id}')" class="text-green-600 hover:text-green-900">Edit</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function calculateAverageScore(scores) {
            const values = Object.values(scores).filter(score => typeof score === 'number');
            if (values.length === 0) return 0;
            const sum = values.reduce((a, b) => a + b, 0);
            return Math.round(sum / values.length);
        }

        function getScoreColor(score) {
            if (score >= 90) return 'green';
            if (score >= 80) return 'blue';
            if (score >= 70) return 'yellow';
            if (score >= 60) return 'orange';
            return 'red';
        }

        function formatAssessmentType(type) {
            return type.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function startAssessment(type) {
            document.getElementById('new-assessment-modal').classList.remove('hidden');
            document.querySelector('select[name="assessment_type"]').value = type;
            updateSkillAreas();
            loadParticipants();
        }

        function hideNewAssessmentForm() {
            document.getElementById('new-assessment-modal').classList.add('hidden');
            document.getElementById('assessment-form').reset();
        }

        function updateSkillAreas() {
            const assessmentType = document.querySelector('select[name="assessment_type"]').value;
            const container = document.getElementById('skill-areas-container');
            
            if (!assessmentType || !skillAreas[assessmentType]) {
                container.innerHTML = '<p class="text-gray-500">Select an assessment type to see skill areas</p>';
                return;
            }

            const skills = skillAreas[assessmentType];
            container.innerHTML = skills.map(skill => `
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">${skill.name}</label>
                        <input type="hidden" name="skill_area" value="${skill.key}">
                    </div>
                    <div>
                        <input type="number" 
                               name="score_${skill.key}" 
                               min="0" 
                               max="100" 
                               class="w-full border rounded px-3 py-2" 
                               placeholder="Score (0-100)">
                    </div>
                </div>
            `).join('');
        }

        async function loadParticipants() {
            try {
                const response = await fetch('/api/compliance/eligibility?status=verified');
                const data = await response.json();
                const select = document.querySelector('select[name="user_id"]');
                
                select.innerHTML = '<option value="">Select Participant</option>';
                data.verifications?.forEach(verification => {
                    select.innerHTML += `<option value="${verification.user_id}">${verification.email}</option>`;
                });
            } catch (error) {
                console.error('Error loading participants:', error);
            }
        }

        async function createAssessment(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            const skillAreas = Array.from(formData.getAll('skill_area'));
            const scores = {};
            skillAreas.forEach(skill => {
                const score = formData.get(`score_${skill}`);
                if (score) {
                    scores[skill] = parseInt(score);
                }
            });
            
            const assessmentData = {
                user_id: formData.get('user_id'),
                assessment_type: formData.get('assessment_type'),
                program_slug: formData.get('program_slug'),
                skill_areas: skillAreas.reduce((acc, skill) => {
                    acc[skill] = true;
                    return acc;
                }, {}),
                scores: scores,
                assessor_id: 'current_user', // In real implementation, get from auth
                notes: formData.get('assessment_notes')
            };

            try {
                const response = await fetch('/api/compliance/skills-assessment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(assessmentData)
                });

                if (response.ok) {
                    hideNewAssessmentForm();
                    loadAssessments();
                    alert('Skills assessment saved successfully!');
                } else {
                    alert('Error saving assessment. Please try again.');
                }
            } catch (error) {
                console.error('Error creating assessment:', error);
                alert('Error saving assessment. Please try again.');
            }
        }

        function viewAssessment(assessmentId) {
            // In real implementation, show detailed view modal
            alert(`Viewing Assessment: ${assessmentId}`);
        }

        function editAssessment(assessmentId) {
            // In real implementation, open edit form
            alert(`Editing Assessment: ${assessmentId}`);
        }

        function filterAssessments() {
            // Filter assessments based on selected criteria
            loadAssessments();
        }

        function searchAssessments() {
            // Search functionality
            loadAssessments();
        }

        function exportAssessments() {
            alert('Exporting assessment data...');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAssessments();
        });
    </script>
</body>
</html>